<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>扣费系统使用指南 | Goppop的博客</title><meta name="author" content="Goppop"><meta name="copyright" content="Goppop"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="文章描述">
<meta property="og:type" content="article">
<meta property="og:title" content="扣费系统使用指南">
<meta property="og:url" content="https://goppop.github.io/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/index.html">
<meta property="og:site_name" content="Goppop的博客">
<meta property="og:description" content="文章描述">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://goppop.github.io/img/butterfly-icon.png">
<meta property="article:published_time" content="2025-12-09T16:00:00.000Z">
<meta property="article:modified_time" content="2025-12-16T03:20:55.935Z">
<meta property="article:author" content="Goppop">
<meta property="article:tag" content="系统开发">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://goppop.github.io/img/butterfly-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "扣费系统使用指南",
  "url": "https://goppop.github.io/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/",
  "image": "https://goppop.github.io/img/butterfly-icon.png",
  "datePublished": "2025-12-09T16:00:00.000Z",
  "dateModified": "2025-12-16T03:20:55.935Z",
  "author": [
    {
      "@type": "Person",
      "name": "Goppop",
      "url": "https://goppop.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://goppop.github.io/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.3-b1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '扣费系统使用指南',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.1.1"></head><body><div id="web_bg" style="background-image: url(https://images.pexels.com/photos/1200252/pexels-photo-1200252.jpeg);"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.pixabay.com/photo/2021/03/29/08/22/peach-flower-6133330_1280.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Goppop的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">扣费系统使用指南</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">扣费系统使用指南</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-12-09T16:00:00.000Z" title="发表于 2025-12-10 00:00:00">2025-12-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-12-16T03:20:55.935Z" title="更新于 2025-12-16 11:20:55">2025-12-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/code-learning/">代码开发学习</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="扣费系统使用指南"><a href="#扣费系统使用指南" class="headerlink" title="扣费系统使用指南"></a>扣费系统使用指南</h1><h2 id="一、系统概述"><a href="#一、系统概述" class="headerlink" title="一、系统概述"></a>一、系统概述</h2><p>扣费系统是算力平台的核心计费模块，支持包月预付费和按小时后付费两种计费方式。系统已完全集成到 pay 模块中。</p>
<h3 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h3><ol>
<li><strong>包月扣费（预付费）</strong>：一次性扣除整月费用</li>
<li><strong>按小时扣费（后付费）</strong>：首小时扣费 + 周期续扣</li>
<li><strong>退款处理</strong>：订单取消或失败时的退款</li>
<li><strong>定时任务</strong>：自动执行周期续扣和对账</li>
<li><strong>同步调用</strong>：直接调用扣费服务，实时返回结果</li>
</ol>
<h2 id="二、数据库表结构"><a href="#二、数据库表结构" class="headerlink" title="二、数据库表结构"></a>二、数据库表结构</h2><h3 id="1-扣费记录表"><a href="#1-扣费记录表" class="headerlink" title="1. 扣费记录表"></a>1. 扣费记录表</h3><p>表名：<code>tgkw_deduction_record</code></p>
<p>SQL文件位置：<code>sql/mysql/system/deduction_record.sql</code></p>
<p>执行以下SQL创建表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在你的MySQL数据库中执行</span></span><br><span class="line">source <span class="keyword">sql</span><span class="operator">/</span>mysql<span class="operator">/</span><span class="keyword">system</span><span class="operator">/</span>deduction_record.sql;</span><br></pre></td></tr></table></figure>

<h2 id="三、API接口说明"><a href="#三、API接口说明" class="headerlink" title="三、API接口说明"></a>三、API接口说明</h2><h3 id="1-创建扣费"><a href="#1-创建扣费" class="headerlink" title="1. 创建扣费"></a>1. 创建扣费</h3><p><strong>接口地址：</strong> <code>POST /admin-api/pay/deduction/create</code></p>
<p><strong>权限：</strong> <code>pay:deduction:create</code></p>
<p><strong>请求示例（包月）：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;orderNo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ORD20231201001&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;instanceId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;INS001&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;deductionType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MONTHLY_PREPAID&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;billingType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MONTHLY&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;amount&quot;</span><span class="punctuation">:</span> <span class="number">100.00</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;unitPrice&quot;</span><span class="punctuation">:</span> <span class="number">100.00</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;durationHours&quot;</span><span class="punctuation">:</span> <span class="number">720</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;isPeriodic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>请求示例（按小时）：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;orderNo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ORD20231201002&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;instanceId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;INS002&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;deductionType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HOURLY_POSTPAID&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;billingType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HOURLY&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;amount&quot;</span><span class="punctuation">:</span> <span class="number">10.00</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;unitPrice&quot;</span><span class="punctuation">:</span> <span class="number">10.00</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;durationHours&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;isPeriodic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;periodHours&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;totalPeriods&quot;</span><span class="punctuation">:</span> <span class="number">-1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>响应示例：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DED1234567890&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;success&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-退款（支持粗粒度和细粒度）"><a href="#2-退款（支持粗粒度和细粒度）" class="headerlink" title="2. 退款（支持粗粒度和细粒度）"></a>2. 退款（支持粗粒度和细粒度）</h3><h4 id="2-1-按订单号退款（粗粒度）"><a href="#2-1-按订单号退款（粗粒度）" class="headerlink" title="2.1 按订单号退款（粗粒度）"></a>2.1 按订单号退款（粗粒度）</h4><p><strong>接口地址：</strong> <code>POST /admin-api/pay/deduction/refund-by-order</code></p>
<p><strong>权限：</strong> <code>pay:deduction:refund</code></p>
<p><strong>适用场景</strong>：订单取消、全额退款</p>
<p><strong>请求示例：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;orderNo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ORD20231201001&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;用户申请退款&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-按扣费单号退款（细粒度）"><a href="#2-2-按扣费单号退款（细粒度）" class="headerlink" title="2.2 按扣费单号退款（细粒度）"></a>2.2 按扣费单号退款（细粒度）</h4><p><strong>接口地址：</strong> <code>POST /admin-api/pay/deduction/refund-by-deduction?deductionNo=DED123&amp;reason=原因</code></p>
<p><strong>权限：</strong> <code>pay:deduction:refund</code></p>
<p><strong>适用场景</strong>：升降配、单次扣费退款</p>
<p><strong>请求参数：</strong></p>
<ul>
<li><code>deductionNo</code>：扣费单号</li>
<li><code>reason</code>：退款原因</li>
</ul>
<h4 id="2-3-部分退款（细粒度）"><a href="#2-3-部分退款（细粒度）" class="headerlink" title="2.3 部分退款（细粒度）"></a>2.3 部分退款（细粒度）</h4><p><strong>接口地址：</strong> <code>POST /admin-api/pay/deduction/partial-refund</code></p>
<p><strong>权限：</strong> <code>pay:deduction:refund</code></p>
<p><strong>适用场景</strong>：提前终止、部分退款</p>
<p><strong>请求参数：</strong></p>
<ul>
<li><code>deductionNo</code>：扣费单号</li>
<li><code>refundAmount</code>：退款金额（必须 &gt; 0 且 &lt;&#x3D; 原扣费金额）</li>
<li><code>reason</code>：退款原因</li>
</ul>
<p><strong>请求示例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /admin-api/pay/deduction/partial-refund?deductionNo=DED20250108002&amp;refundAmount=2000.00&amp;reason=提前终止</span><br></pre></td></tr></table></figure>

<h3 id="3-停止周期扣费（支持粗粒度和细粒度）"><a href="#3-停止周期扣费（支持粗粒度和细粒度）" class="headerlink" title="3. 停止周期扣费（支持粗粒度和细粒度）"></a>3. 停止周期扣费（支持粗粒度和细粒度）</h3><h4 id="3-1-按订单号停止（粗粒度）"><a href="#3-1-按订单号停止（粗粒度）" class="headerlink" title="3.1 按订单号停止（粗粒度）"></a>3.1 按订单号停止（粗粒度）</h4><p><strong>接口地址：</strong> <code>POST /admin-api/pay/deduction/stop-periodic-by-order?orderNo=ORD20231201002</code></p>
<p><strong>权限：</strong> <code>pay:deduction:stop</code></p>
<p><strong>适用场景</strong>：订单取消、批量停止</p>
<h4 id="3-2-按扣费单号停止（细粒度）"><a href="#3-2-按扣费单号停止（细粒度）" class="headerlink" title="3.2 按扣费单号停止（细粒度）"></a>3.2 按扣费单号停止（细粒度）</h4><p><strong>接口地址：</strong> <code>POST /admin-api/pay/deduction/stop-periodic-by-deduction?deductionNo=DED123</code></p>
<p><strong>权限：</strong> <code>pay:deduction:stop</code></p>
<h3 id="4-查询扣费记录"><a href="#4-查询扣费记录" class="headerlink" title="4. 查询扣费记录"></a>4. 查询扣费记录</h3><p><strong>接口地址：</strong> <code>GET /admin-api/pay/deduction/get?id=1</code></p>
<p><strong>权限：</strong> <code>pay:deduction:query</code></p>
<h3 id="5-根据订单号查询"><a href="#5-根据订单号查询" class="headerlink" title="5. 根据订单号查询"></a>5. 根据订单号查询</h3><p><strong>接口地址：</strong> <code>GET /admin-api/pay/deduction/get-by-order?orderNo=ORD20231201001</code></p>
<p><strong>权限：</strong> <code>pay:deduction:query</code></p>
<h3 id="6-分页查询"><a href="#6-分页查询" class="headerlink" title="6. 分页查询"></a>6. 分页查询</h3><p><strong>接口地址：</strong> <code>GET /admin-api/pay/deduction/page</code></p>
<p><strong>权限：</strong> <code>pay:deduction:query</code></p>
<p><strong>请求参数：</strong></p>
<ul>
<li><code>pageNo</code>: 页码（必填）</li>
<li><code>pageSize</code>: 每页条数（必填）</li>
<li><code>orderNo</code>: 订单号（可选）</li>
<li><code>userId</code>: 用户ID（可选）</li>
<li><code>instanceId</code>: 实例ID（可选）</li>
<li><code>deductionType</code>: 扣费类型（可选）</li>
<li><code>status</code>: 状态（可选）</li>
</ul>
<h2 id="四、定时任务配置"><a href="#四、定时任务配置" class="headerlink" title="四、定时任务配置"></a>四、定时任务配置</h2><h3 id="1-按小时续扣任务"><a href="#1-按小时续扣任务" class="headerlink" title="1. 按小时续扣任务"></a>1. 按小时续扣任务</h3><p>在 XXL-Job 管理后台添加定时任务：</p>
<ul>
<li><strong>执行器：</strong> pay-executor</li>
<li><strong>任务描述：</strong> 按小时续扣任务</li>
<li><strong>Cron表达式：</strong> <code>0 * * * * ?</code> （每分钟执行一次）</li>
<li><strong>JobHandler：</strong> <code>hourlyDeductionJob</code></li>
<li><strong>路由策略：</strong> 第一个</li>
<li><strong>阻塞处理策略：</strong> 单机串行</li>
</ul>
<h3 id="2-对账任务"><a href="#2-对账任务" class="headerlink" title="2. 对账任务"></a>2. 对账任务</h3><ul>
<li><strong>执行器：</strong> pay-executor</li>
<li><strong>任务描述：</strong> 扣费对账任务</li>
<li><strong>Cron表达式：</strong> <code>0 0 2 * * ?</code> （每天凌晨2点执行）</li>
<li><strong>JobHandler：</strong> <code>deductionReconciliationJob</code></li>
<li><strong>路由策略：</strong> 第一个</li>
<li><strong>阻塞处理策略：</strong> 单机串行</li>
</ul>
<h2 id="五、代码集成示例"><a href="#五、代码集成示例" class="headerlink" title="五、代码集成示例"></a>五、代码集成示例</h2><h3 id="1-订单支付成功后扣费"><a href="#1-订单支付成功后扣费" class="headerlink" title="1. 订单支付成功后扣费"></a>1. 订单支付成功后扣费</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DeductionService deductionService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleOrderPaid</span><span class="params">(OrderDO order)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 构建扣费请求</span></span><br><span class="line">        <span class="type">DeductionRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeductionRequest</span>();</span><br><span class="line">        request.setOrderNo(order.getOrderNo());</span><br><span class="line">        request.setUserId(order.getUserId());</span><br><span class="line">        request.setInstanceId(order.getInstanceId());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;MONTHLY&quot;</span>.equals(order.getBillingType())) &#123;</span><br><span class="line">            <span class="comment">// 包月扣费</span></span><br><span class="line">            request.setDeductionType(<span class="string">&quot;MONTHLY_PREPAID&quot;</span>);</span><br><span class="line">            request.setBillingType(<span class="string">&quot;MONTHLY&quot;</span>);</span><br><span class="line">            request.setAmount(order.getAmount());</span><br><span class="line">            request.setIsPeriodic(<span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 按小时扣费</span></span><br><span class="line">            request.setDeductionType(<span class="string">&quot;HOURLY_POSTPAID&quot;</span>);</span><br><span class="line">            request.setBillingType(<span class="string">&quot;HOURLY&quot;</span>);</span><br><span class="line">            request.setAmount(order.getUnitPrice()); <span class="comment">// 首小时费用</span></span><br><span class="line">            request.setUnitPrice(order.getUnitPrice());</span><br><span class="line">            request.setIsPeriodic(<span class="literal">true</span>);</span><br><span class="line">            request.setPeriodHours(<span class="number">1</span>);</span><br><span class="line">            request.setTotalPeriods(-<span class="number">1</span>); <span class="comment">// 无限续扣</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 执行扣费</span></span><br><span class="line">        <span class="type">DeductionResult</span> <span class="variable">result</span> <span class="operator">=</span> deductionService.deduct(request);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (result.getSuccess()) &#123;</span><br><span class="line">            <span class="comment">// 扣费成功，更新订单状态</span></span><br><span class="line">            order.setStatus(<span class="string">&quot;PAID&quot;</span>);</span><br><span class="line">            order.setDeductionNo(result.getDeductionNo());</span><br><span class="line">            orderMapper.updateById(order);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 扣费失败，抛出异常回滚订单</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;扣费失败：&quot;</span> + result.getFailReason());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-实例释放时退款"><a href="#2-实例释放时退款" class="headerlink" title="2. 实例释放时退款"></a>2. 实例释放时退款</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InstanceServiceImpl</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DeductionService deductionService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">releaseInstance</span><span class="params">(String instanceId, String orderNo)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 释放实例资源</span></span><br><span class="line">        <span class="comment">// ... 实例释放逻辑</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 退款（粗粒度：按订单号退款）</span></span><br><span class="line">        <span class="type">RefundResult</span> <span class="variable">result</span> <span class="operator">=</span> deductionService.refundByOrderNo(orderNo, <span class="string">&quot;实例释放&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (result.getSuccess()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;退款成功：orderNo=&#123;&#125;, amount=&#123;&#125;&quot;</span>, </span><br><span class="line">                orderNo, result.getRefundAmount());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;退款失败：orderNo=&#123;&#125;, reason=&#123;&#125;&quot;</span>, </span><br><span class="line">                orderNo, result.getFailReason());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-升配场景（细粒度控制）"><a href="#3-升配场景（细粒度控制）" class="headerlink" title="3. 升配场景（细粒度控制）"></a>3. 升配场景（细粒度控制）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InstanceUpgradeService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DeductionService deductionService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upgradeInstance</span><span class="params">(String orderNo, String instanceId, </span></span><br><span class="line"><span class="params">                                 BigDecimal newHourlyPrice)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 查询订单的所有扣费记录</span></span><br><span class="line">        List&lt;DeductionRecordDO&gt; records = deductionRecordMapper.selectByOrderNo(orderNo);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 找到旧配置的扣费记录（按创建时间最早）</span></span><br><span class="line">        <span class="type">DeductionRecordDO</span> <span class="variable">oldRecord</span> <span class="operator">=</span> records.stream()</span><br><span class="line">            .filter(r -&gt; r.getIsPeriodic() == <span class="number">1</span>)</span><br><span class="line">            .min(Comparator.comparing(DeductionRecordDO::getCreateTime))</span><br><span class="line">            .orElse(<span class="literal">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 停止旧配置的周期扣费（细粒度：按扣费单号）</span></span><br><span class="line">        <span class="keyword">if</span> (oldRecord != <span class="literal">null</span>) &#123;</span><br><span class="line">            deductionService.stopPeriodicDeductionByDeductionNo(</span><br><span class="line">                oldRecord.getDeductionNo()</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 创建新配置的扣费请求</span></span><br><span class="line">        <span class="type">DeductionRequest</span> <span class="variable">newRequest</span> <span class="operator">=</span> DeductionRequest.builder()</span><br><span class="line">            .orderNo(orderNo)</span><br><span class="line">            .userId(userId)</span><br><span class="line">            .instanceId(instanceId)</span><br><span class="line">            .deductionType(DeductionTypeEnum.HOURLY_POSTPAID.getCode())</span><br><span class="line">            .amount(newHourlyPrice)</span><br><span class="line">            .isPeriodic(<span class="literal">true</span>)</span><br><span class="line">            .build();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. 执行新配置的首次扣费</span></span><br><span class="line">        deductionService.deduct(newRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-提前终止退款（部分退款）"><a href="#4-提前终止退款（部分退款）" class="headerlink" title="4. 提前终止退款（部分退款）"></a>4. 提前终止退款（部分退款）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EarlyTerminationService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DeductionService deductionService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">terminateEarly</span><span class="params">(String deductionNo, <span class="type">int</span> usedDays, <span class="type">int</span> totalDays)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 查询扣费记录</span></span><br><span class="line">        <span class="type">DeductionRecordDO</span> <span class="variable">record</span> <span class="operator">=</span> deductionRecordMapper.selectByDeductionNo(deductionNo);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 计算退款金额</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">totalAmount</span> <span class="operator">=</span> record.getAmount();</span><br><span class="line">        <span class="type">int</span> <span class="variable">remainingDays</span> <span class="operator">=</span> totalDays - usedDays;</span><br><span class="line">        </span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">refundAmount</span> <span class="operator">=</span> totalAmount</span><br><span class="line">            .multiply(BigDecimal.valueOf(remainingDays))</span><br><span class="line">            .divide(BigDecimal.valueOf(totalDays), <span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 执行部分退款（细粒度）</span></span><br><span class="line">        <span class="type">RefundResult</span> <span class="variable">result</span> <span class="operator">=</span> deductionService.partialRefund(</span><br><span class="line">            deductionNo,</span><br><span class="line">            refundAmount,</span><br><span class="line">            String.format(<span class="string">&quot;提前终止，退还剩余%d天费用&quot;</span>, remainingDays)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (result.getSuccess()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;部分退款成功：deductionNo=&#123;&#125;, amount=&#123;&#125;&quot;</span>,</span><br><span class="line">                deductionNo, refundAmount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="六、扣费状态流转"><a href="#六、扣费状态流转" class="headerlink" title="六、扣费状态流转"></a>六、扣费状态流转</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PENDING（待扣费）</span><br><span class="line">    ↓</span><br><span class="line">SUCCESS（扣费成功）→ STOPPED（已停止）</span><br><span class="line">    ↓                     ↓</span><br><span class="line">FAILED（扣费失败）     REFUNDED（已退款）</span><br></pre></td></tr></table></figure>

<h2 id="七、幂等性保证"><a href="#七、幂等性保证" class="headerlink" title="七、幂等性保证"></a>七、幂等性保证</h2><p>系统通过以下机制保证幂等性：</p>
<ol>
<li><p><strong>幂等键：</strong> <code>{orderNo}_{deductionType}_{period}</code></p>
<ul>
<li>包月扣费：<code>ORD001_MONTHLY_PREPAID_0</code></li>
<li>按小时首扣：<code>ORD002_HOURLY_POSTPAID_0</code></li>
<li>按小时续扣（第2次）：<code>ORD002_HOURLY_POSTPAID_1</code></li>
</ul>
</li>
<li><p><strong>数据库唯一索引：</strong> <code>uk_idempotent_key</code></p>
</li>
<li><p><strong>重复调用处理：</strong></p>
<ul>
<li>如果幂等键已存在且状态为SUCCESS，直接返回成功结果</li>
<li>如果幂等键已存在且状态为FAILED，检查重试次数后决定是否重试</li>
</ul>
</li>
</ol>
<h2 id="八、监控指标"><a href="#八、监控指标" class="headerlink" title="八、监控指标"></a>八、监控指标</h2><p>建议监控以下指标：</p>
<ol>
<li><strong>扣费成功率：</strong> 成功扣费数 &#x2F; 总扣费数</li>
<li><strong>余额不足率：</strong> 余额不足次数 &#x2F; 总扣费数</li>
<li><strong>平均扣费耗时：</strong> 扣费接口平均响应时间</li>
<li><strong>周期扣费延迟：</strong> 实际扣费时间 - 计划扣费时间</li>
</ol>
<h2 id="九、常见问题"><a href="#九、常见问题" class="headerlink" title="九、常见问题"></a>九、常见问题</h2><h3 id="1-余额不足怎么办？"><a href="#1-余额不足怎么办？" class="headerlink" title="1. 余额不足怎么办？"></a>1. 余额不足怎么办？</h3><ul>
<li>系统会记录失败原因并发送余额不足通知</li>
<li>用户充值后可以手动重试或等待下次续扣</li>
<li>可以配置自动停止实例</li>
</ul>
<h3 id="2-扣费失败如何重试？"><a href="#2-扣费失败如何重试？" class="headerlink" title="2. 扣费失败如何重试？"></a>2. 扣费失败如何重试？</h3><ul>
<li>系统默认最多重试3次</li>
<li>可以通过管理后台手动创建扣费记录重试</li>
</ul>
<h3 id="3-如何停止周期扣费？"><a href="#3-如何停止周期扣费？" class="headerlink" title="3. 如何停止周期扣费？"></a>3. 如何停止周期扣费？</h3><ul>
<li>调用停止周期扣费接口</li>
<li>或者执行退款操作，系统会自动停止周期扣费</li>
</ul>
<h3 id="4-对账不平怎么办？"><a href="#4-对账不平怎么办？" class="headerlink" title="4. 对账不平怎么办？"></a>4. 对账不平怎么办？</h3><ul>
<li>查看对账任务日志，定位具体差异</li>
<li>检查扣费记录表和账户流水表数据</li>
<li>必要时手动调整数据并记录</li>
</ul>
<h2 id="十、日志配置"><a href="#十、日志配置" class="headerlink" title="十、日志配置"></a>十、日志配置</h2><p>在 <code>application-dev.yaml</code> 中添加日志配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">cn.ksxzcx.cloud.module.pay.service.deduction:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="attr">cn.ksxzcx.cloud.module.pay.dal.mysql.deduction:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="attr">cn.ksxzcx.cloud.module.pay.job:</span> <span class="string">DEBUG</span></span><br><span class="line">    <span class="attr">cn.ksxzcx.cloud.module.pay.mq.consumer:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://goppop.github.io">Goppop</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://goppop.github.io/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/">https://goppop.github.io/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://goppop.github.io" target="_blank">Goppop的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/">系统开发</a></div><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/" title="算力平台扣费系统设计方案"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">算力平台扣费系统设计方案</div></div><div class="info-2"><div class="info-item-1">算力平台扣费系统设计方案一、设计目标1.1 核心需求 包月（预付费）：一次性扣除整月费用 按小时计费（后付费）：先扣首小时费用，后续每小时自动续扣 资金安全：不重复扣、不多退 操作幂等：同一订单多次调用只生效一次 高可用 &amp; 可对账：支持故障恢复和数据核对 系统解耦：与订单&#x2F;资源系统解耦，通过消息队列异步通信  1.2 设计原则 最终一致性：允许短暂的数据不一致，通过补偿机制保证最终一致 幂等优先：所有扣费操作必须支持幂等 可追溯性：每笔扣费都有完整的流水记录 故障隔离：扣费系统故障不影响订单和资源系统   二、核心架构设计2.1 系统分层123456789101112131415161718192021222324252627282930313233343536373839404142434445┌─────────────────────────────────────────────────────────┐│                    订单系统                              ││  ┌──────────────┐...</div></div></div></a><a class="pagination-related" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F-%E4%BB%8E%E8%AE%BE%E8%AE%A1%E5%88%B0%E5%BC%80%E5%8F%91%E5%85%A8%E8%BF%87%E7%A8%8B/" title="算力平台扣费系统：从设计到开发全过程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">算力平台扣费系统：从设计到开发全过程</div></div><div class="info-2"><div class="info-item-1">算力平台扣费系统：从设计到开发全过程 本文记录了一个完整的分布式扣费系统的设计思路、技术选型、架构设计、核心实现以及踩坑经验，适合有一定Java开发经验的读者阅读。  目录 一、项目背景 二、需求分析 三、技术选型 四、架构设计 五、数据库设计 六、核心功能实现 七、关键技术点 八、踩坑与优化 九、测试与验证 十、总结与思考   一、项目背景1.1 业务场景这是一个算力租赁平台的扣费系统，主要业务场景包括：  包月预付费：用户购买包月算力，一次性扣除整月费用 按小时后付费：用户按小时使用算力，每小时自动续扣 退款处理：支持全额退款、部分退款、按订单退款、按扣费单退款 余额预警：提前通知用户余额不足，避免服务突然中断  1.2 核心挑战 资金安全：不能重复扣费，不能多退少退 高并发：支持大量用户同时扣费 幂等性：网络重试、系统故障恢复时不能重复扣费 系统解耦：与订单系统、资源系统解耦，通过消息队列异步通信 可追溯性：每笔扣费都有完整的流水记录，支持对账   二、需求分析2.1 功能需求2.1.1 扣费功能   功能 说明 优先级    包月扣费 一次性扣除整月费用 P0   按小时...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F-%E4%BB%8E%E8%AE%BE%E8%AE%A1%E5%88%B0%E5%BC%80%E5%8F%91%E5%85%A8%E8%BF%87%E7%A8%8B/" title="算力平台扣费系统：从设计到开发全过程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-10</div><div class="info-item-2">算力平台扣费系统：从设计到开发全过程</div></div><div class="info-2"><div class="info-item-1">算力平台扣费系统：从设计到开发全过程 本文记录了一个完整的分布式扣费系统的设计思路、技术选型、架构设计、核心实现以及踩坑经验，适合有一定Java开发经验的读者阅读。  目录 一、项目背景 二、需求分析 三、技术选型 四、架构设计 五、数据库设计 六、核心功能实现 七、关键技术点 八、踩坑与优化 九、测试与验证 十、总结与思考   一、项目背景1.1 业务场景这是一个算力租赁平台的扣费系统，主要业务场景包括：  包月预付费：用户购买包月算力，一次性扣除整月费用 按小时后付费：用户按小时使用算力，每小时自动续扣 退款处理：支持全额退款、部分退款、按订单退款、按扣费单退款 余额预警：提前通知用户余额不足，避免服务突然中断  1.2 核心挑战 资金安全：不能重复扣费，不能多退少退 高并发：支持大量用户同时扣费 幂等性：网络重试、系统故障恢复时不能重复扣费 系统解耦：与订单系统、资源系统解耦，通过消息队列异步通信 可追溯性：每笔扣费都有完整的流水记录，支持对账   二、需求分析2.1 功能需求2.1.1 扣费功能   功能 说明 优先级    包月扣费 一次性扣除整月费用 P0   按小时...</div></div></div></a><a class="pagination-related" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/" title="算力平台扣费系统设计方案"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-10</div><div class="info-item-2">算力平台扣费系统设计方案</div></div><div class="info-2"><div class="info-item-1">算力平台扣费系统设计方案一、设计目标1.1 核心需求 包月（预付费）：一次性扣除整月费用 按小时计费（后付费）：先扣首小时费用，后续每小时自动续扣 资金安全：不重复扣、不多退 操作幂等：同一订单多次调用只生效一次 高可用 &amp; 可对账：支持故障恢复和数据核对 系统解耦：与订单&#x2F;资源系统解耦，通过消息队列异步通信  1.2 设计原则 最终一致性：允许短暂的数据不一致，通过补偿机制保证最终一致 幂等优先：所有扣费操作必须支持幂等 可追溯性：每笔扣费都有完整的流水记录 故障隔离：扣费系统故障不影响订单和资源系统   二、核心架构设计2.1 系统分层123456789101112131415161718192021222324252627282930313233343536373839404142434445┌─────────────────────────────────────────────────────────┐│                    订单系统                              ││  ┌──────────────┐...</div></div></div></a><a class="pagination-related" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%8E%A5%E6%96%87%E6%A1%A3/" title="扣费系统对接文档"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-10</div><div class="info-item-2">扣费系统对接文档</div></div><div class="info-2"><div class="info-item-1">扣费系统对接文档1. 概述扣费系统为订单系统提供统一的扣费和退款能力，支持一次性扣费和周期性扣费两种模式。 核心能力：  一次性扣费（包月预付费） 周期扣费（按小时后付费） 全额退款和部分退款 停止周期扣费 余额预警（提前3天和1天预警） 幂等性保证  服务信息：  服务名称：pay-server 基础路径：&#x2F;admin-api&#x2F;pay&#x2F;deduction  快速导航：  如何对接扣费接口：见 第2章：快速开始 如何使用余额预警：见 第7.4节：订单系统如何使用 消息推送说明：见 第6章：消息推送 典型场景示例：见 第5章：典型场景  2. 快速开始2.1 添加依赖12345&lt;dependency&gt;    &lt;groupId&gt;cn.ksxzcx.cloud&lt;/groupId&gt;    &lt;artifactId&gt;tgwk-module-pay-api&lt;/artifactId&gt;    &lt;version&gt;$&#123;project.version&#125;&lt;/version&gt;...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Goppop</div><div class="author-info-description">周期越大，结构越清晰</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">22</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Goppop"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97"><span class="toc-number">1.</span> <span class="toc-text">扣费系统使用指南</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">一、系统概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-number">1.1.1.</span> <span class="toc-text">核心功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">二、数据库表结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%89%A3%E8%B4%B9%E8%AE%B0%E5%BD%95%E8%A1%A8"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 扣费记录表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81API%E6%8E%A5%E5%8F%A3%E8%AF%B4%E6%98%8E"><span class="toc-number">1.3.</span> <span class="toc-text">三、API接口说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA%E6%89%A3%E8%B4%B9"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. 创建扣费</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%80%80%E6%AC%BE%EF%BC%88%E6%94%AF%E6%8C%81%E7%B2%97%E7%B2%92%E5%BA%A6%E5%92%8C%E7%BB%86%E7%B2%92%E5%BA%A6%EF%BC%89"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. 退款（支持粗粒度和细粒度）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%8C%89%E8%AE%A2%E5%8D%95%E5%8F%B7%E9%80%80%E6%AC%BE%EF%BC%88%E7%B2%97%E7%B2%92%E5%BA%A6%EF%BC%89"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">2.1 按订单号退款（粗粒度）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%8C%89%E6%89%A3%E8%B4%B9%E5%8D%95%E5%8F%B7%E9%80%80%E6%AC%BE%EF%BC%88%E7%BB%86%E7%B2%92%E5%BA%A6%EF%BC%89"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2.2 按扣费单号退款（细粒度）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E9%83%A8%E5%88%86%E9%80%80%E6%AC%BE%EF%BC%88%E7%BB%86%E7%B2%92%E5%BA%A6%EF%BC%89"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">2.3 部分退款（细粒度）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%81%9C%E6%AD%A2%E5%91%A8%E6%9C%9F%E6%89%A3%E8%B4%B9%EF%BC%88%E6%94%AF%E6%8C%81%E7%B2%97%E7%B2%92%E5%BA%A6%E5%92%8C%E7%BB%86%E7%B2%92%E5%BA%A6%EF%BC%89"><span class="toc-number">1.3.3.</span> <span class="toc-text">3. 停止周期扣费（支持粗粒度和细粒度）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E6%8C%89%E8%AE%A2%E5%8D%95%E5%8F%B7%E5%81%9C%E6%AD%A2%EF%BC%88%E7%B2%97%E7%B2%92%E5%BA%A6%EF%BC%89"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">3.1 按订单号停止（粗粒度）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%8C%89%E6%89%A3%E8%B4%B9%E5%8D%95%E5%8F%B7%E5%81%9C%E6%AD%A2%EF%BC%88%E7%BB%86%E7%B2%92%E5%BA%A6%EF%BC%89"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">3.2 按扣费单号停止（细粒度）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%9F%A5%E8%AF%A2%E6%89%A3%E8%B4%B9%E8%AE%B0%E5%BD%95"><span class="toc-number">1.3.4.</span> <span class="toc-text">4. 查询扣费记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%A0%B9%E6%8D%AE%E8%AE%A2%E5%8D%95%E5%8F%B7%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.3.5.</span> <span class="toc-text">5. 根据订单号查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.3.6.</span> <span class="toc-text">6. 分页查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.</span> <span class="toc-text">四、定时任务配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%8C%89%E5%B0%8F%E6%97%B6%E7%BB%AD%E6%89%A3%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.4.1.</span> <span class="toc-text">1. 按小时续扣任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AF%B9%E8%B4%A6%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.4.2.</span> <span class="toc-text">2. 对账任务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E4%BB%A3%E7%A0%81%E9%9B%86%E6%88%90%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.5.</span> <span class="toc-text">五、代码集成示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98%E6%88%90%E5%8A%9F%E5%90%8E%E6%89%A3%E8%B4%B9"><span class="toc-number">1.5.1.</span> <span class="toc-text">1. 订单支付成功后扣费</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%9E%E4%BE%8B%E9%87%8A%E6%94%BE%E6%97%B6%E9%80%80%E6%AC%BE"><span class="toc-number">1.5.2.</span> <span class="toc-text">2. 实例释放时退款</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%8D%87%E9%85%8D%E5%9C%BA%E6%99%AF%EF%BC%88%E7%BB%86%E7%B2%92%E5%BA%A6%E6%8E%A7%E5%88%B6%EF%BC%89"><span class="toc-number">1.5.3.</span> <span class="toc-text">3. 升配场景（细粒度控制）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%8F%90%E5%89%8D%E7%BB%88%E6%AD%A2%E9%80%80%E6%AC%BE%EF%BC%88%E9%83%A8%E5%88%86%E9%80%80%E6%AC%BE%EF%BC%89"><span class="toc-number">1.5.4.</span> <span class="toc-text">4. 提前终止退款（部分退款）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%89%A3%E8%B4%B9%E7%8A%B6%E6%80%81%E6%B5%81%E8%BD%AC"><span class="toc-number">1.6.</span> <span class="toc-text">六、扣费状态流转</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%B9%82%E7%AD%89%E6%80%A7%E4%BF%9D%E8%AF%81"><span class="toc-number">1.7.</span> <span class="toc-text">七、幂等性保证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="toc-number">1.8.</span> <span class="toc-text">八、监控指标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">1.9.</span> <span class="toc-text">九、常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BD%99%E9%A2%9D%E4%B8%8D%E8%B6%B3%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-number">1.9.1.</span> <span class="toc-text">1. 余额不足怎么办？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%89%A3%E8%B4%B9%E5%A4%B1%E8%B4%A5%E5%A6%82%E4%BD%95%E9%87%8D%E8%AF%95%EF%BC%9F"><span class="toc-number">1.9.2.</span> <span class="toc-text">2. 扣费失败如何重试？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%A6%82%E4%BD%95%E5%81%9C%E6%AD%A2%E5%91%A8%E6%9C%9F%E6%89%A3%E8%B4%B9%EF%BC%9F"><span class="toc-number">1.9.3.</span> <span class="toc-text">3. 如何停止周期扣费？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%AF%B9%E8%B4%A6%E4%B8%8D%E5%B9%B3%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-number">1.9.4.</span> <span class="toc-text">4. 对账不平怎么办？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE"><span class="toc-number">1.10.</span> <span class="toc-text">十、日志配置</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/trading-log/%E4%BA%A4%E6%98%93/%E4%BA%A4%E6%98%93%E8%AE%B0%E5%BD%95%EF%BC%9AETH%20%E5%90%88%E7%BA%A6%E5%A4%9A%E5%8D%95/" title="交易记录">交易记录</a><time datetime="2025-12-21T16:00:00.000Z" title="发表于 2025-12-22 00:00:00">2025-12-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/Java%20%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88JUC%EF%BC%89%E9%AB%98%E7%BA%A7%E7%BB%84%E4%BB%B6%E4%B8%8E%E5%8E%9F%E7%90%86%EF%BC%9A%E4%BB%8E%20AQS%20%E5%88%B0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%20(1)/" title="Java 并发编程（JUC）高级组件与原理：从 AQS 到并发容器">Java 并发编程（JUC）高级组件与原理：从 AQS 到并发容器</a><time datetime="2025-12-16T16:00:00.000Z" title="发表于 2025-12-17 00:00:00">2025-12-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/Spring%20Boot%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9AAOP%E3%80%81IOC%20%E4%B8%8E%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE/" title="Spring Boot 核心原理与源码解析：AOP、IOC 与自动配置">Spring Boot 核心原理与源码解析：AOP、IOC 与自动配置</a><time datetime="2025-12-16T16:00:00.000Z" title="发表于 2025-12-17 00:00:00">2025-12-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/code-learning/programming-basics/jvm/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/JVM-%E5%85%A5%E9%97%A8%E6%A6%82%E8%A7%88/" title="JVM-入门概览">JVM-入门概览</a><time datetime="2025-12-11T16:00:00.000Z" title="发表于 2025-12-12 00:00:00">2025-12-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/code-learning/programming-basics/jvm/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/JVM-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E8%AF%A6%E8%A7%A3/" title="JVM-内存模型详解">JVM-内存模型详解</a><time datetime="2025-12-11T16:00:00.000Z" title="发表于 2025-12-12 00:00:00">2025-12-12</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Goppop</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.1.1</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.3-b1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3-b1"></script><script src="/js/main.js?v=5.5.3-b1"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>