<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>扣费系统对接文档 | Goppop的博客</title><meta name="author" content="Goppop"><meta name="copyright" content="Goppop"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="文章描述">
<meta property="og:type" content="article">
<meta property="og:title" content="扣费系统对接文档">
<meta property="og:url" content="https://goppop.github.io/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%8E%A5%E6%96%87%E6%A1%A3/index.html">
<meta property="og:site_name" content="Goppop的博客">
<meta property="og:description" content="文章描述">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://goppop.github.io/img/butterfly-icon.png">
<meta property="article:published_time" content="2025-12-09T16:00:00.000Z">
<meta property="article:modified_time" content="2025-12-16T03:20:55.935Z">
<meta property="article:author" content="Goppop">
<meta property="article:tag" content="系统开发">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://goppop.github.io/img/butterfly-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "扣费系统对接文档",
  "url": "https://goppop.github.io/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%8E%A5%E6%96%87%E6%A1%A3/",
  "image": "https://goppop.github.io/img/butterfly-icon.png",
  "datePublished": "2025-12-09T16:00:00.000Z",
  "dateModified": "2025-12-16T03:20:55.935Z",
  "author": [
    {
      "@type": "Person",
      "name": "Goppop",
      "url": "https://goppop.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://goppop.github.io/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%8E%A5%E6%96%87%E6%A1%A3/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.3-b1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '扣费系统对接文档',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.1.1"></head><body><div id="web_bg" style="background-image: url(https://images.pexels.com/photos/1200252/pexels-photo-1200252.jpeg);"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.pixabay.com/photo/2021/03/29/08/22/peach-flower-6133330_1280.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Goppop的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">扣费系统对接文档</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">扣费系统对接文档</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-12-09T16:00:00.000Z" title="发表于 2025-12-10 00:00:00">2025-12-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-12-16T03:20:55.935Z" title="更新于 2025-12-16 11:20:55">2025-12-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/code-learning/">代码开发学习</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="扣费系统对接文档"><a href="#扣费系统对接文档" class="headerlink" title="扣费系统对接文档"></a>扣费系统对接文档</h1><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p>扣费系统为订单系统提供统一的扣费和退款能力，支持一次性扣费和周期性扣费两种模式。</p>
<p><strong>核心能力：</strong></p>
<ul>
<li>一次性扣费（包月预付费）</li>
<li>周期扣费（按小时后付费）</li>
<li>全额退款和部分退款</li>
<li>停止周期扣费</li>
<li>余额预警（提前3天和1天预警）</li>
<li>幂等性保证</li>
</ul>
<p><strong>服务信息：</strong></p>
<ul>
<li>服务名称：pay-server</li>
<li>基础路径：&#x2F;admin-api&#x2F;pay&#x2F;deduction</li>
</ul>
<p><strong>快速导航：</strong></p>
<ul>
<li>如何对接扣费接口：见 <a href="#2-%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">第2章：快速开始</a></li>
<li>如何使用余额预警：见 <a href="#74-%E8%AE%A2%E5%8D%95%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8">第7.4节：订单系统如何使用</a></li>
<li>消息推送说明：见 <a href="#6-%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81">第6章：消息推送</a></li>
<li>典型场景示例：见 <a href="#5-%E5%85%B8%E5%9E%8B%E5%9C%BA%E6%99%AF">第5章：典型场景</a></li>
</ul>
<h2 id="2-快速开始"><a href="#2-快速开始" class="headerlink" title="2. 快速开始"></a>2. 快速开始</h2><h3 id="2-1-添加依赖"><a href="#2-1-添加依赖" class="headerlink" title="2.1 添加依赖"></a>2.1 添加依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.ksxzcx.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tgwk-module-pay-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-注入接口"><a href="#2-2-注入接口" class="headerlink" title="2.2 注入接口"></a>2.2 注入接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DeductionApi deductionApi;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-执行扣费"><a href="#2-3-执行扣费" class="headerlink" title="2.3 执行扣费"></a>2.3 执行扣费</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建扣费请求</span></span><br><span class="line"><span class="type">DeductionRequestDTO</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeductionRequestDTO</span>();</span><br><span class="line">request.setOrderNo(<span class="string">&quot;ORDER_20251210_001&quot;</span>);</span><br><span class="line">request.setUserId(<span class="number">1L</span>);</span><br><span class="line">request.setInstanceId(<span class="string">&quot;INS_001&quot;</span>);</span><br><span class="line">request.setDeductionType(<span class="string">&quot;HOURLY_POSTPAID&quot;</span>);</span><br><span class="line">request.setBillingType(<span class="string">&quot;HOURLY&quot;</span>);</span><br><span class="line">request.setAmount(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;10.00&quot;</span>));</span><br><span class="line">request.setUnitPrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;10.00&quot;</span>));</span><br><span class="line">request.setDurationHours(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;1&quot;</span>));</span><br><span class="line">request.setIsPeriodic(<span class="literal">true</span>);</span><br><span class="line">request.setPeriodHours(<span class="number">1</span>);</span><br><span class="line">request.setTotalPeriods(-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行扣费</span></span><br><span class="line">CommonResult&lt;DeductionResultDTO&gt; result = deductionApi.deduct(request);</span><br><span class="line"><span class="keyword">if</span> (result.isSuccess() &amp;&amp; result.getData().getSuccess()) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">deductionNo</span> <span class="operator">=</span> result.getData().getDeductionNo();</span><br><span class="line">    <span class="comment">// 扣费成功，保存扣费单号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-核心概念"><a href="#3-核心概念" class="headerlink" title="3. 核心概念"></a>3. 核心概念</h2><h3 id="3-1-扣费类型"><a href="#3-1-扣费类型" class="headerlink" title="3.1 扣费类型"></a>3.1 扣费类型</h3><table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
<th>是否周期</th>
</tr>
</thead>
<tbody><tr>
<td>MONTHLY_PREPAID</td>
<td>包月预付费</td>
<td>否</td>
</tr>
<tr>
<td>HOURLY_POSTPAID</td>
<td>按小时后付费</td>
<td>是</td>
</tr>
</tbody></table>
<h3 id="3-2-主记录与明细记录"><a href="#3-2-主记录与明细记录" class="headerlink" title="3.2 主记录与明细记录"></a>3.2 主记录与明细记录</h3><p><strong>主记录（DeductionRecord）：</strong></p>
<ul>
<li>每个订单只有1条主记录</li>
<li>记录订单级别的扣费配置</li>
<li>周期扣费时记录当前期数和下次扣费时间</li>
</ul>
<p><strong>明细记录（DeductionDetail）：</strong></p>
<ul>
<li>每次实际扣费产生1条明细</li>
<li>记录每期的扣费金额、状态、时间</li>
<li>支持独立退款</li>
</ul>
<p><strong>关系说明：</strong></p>
<ul>
<li>一次性扣费：1个主记录 + 1个明细记录</li>
<li>周期扣费：1个主记录 + N个明细记录（N&#x3D;实际扣费次数）</li>
</ul>
<h3 id="3-3-扣费状态"><a href="#3-3-扣费状态" class="headerlink" title="3.3 扣费状态"></a>3.3 扣费状态</h3><table>
<thead>
<tr>
<th>状态</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>PENDING</td>
<td>待扣费</td>
</tr>
<tr>
<td>SUCCESS</td>
<td>扣费成功</td>
</tr>
<tr>
<td>FAILED</td>
<td>扣费失败</td>
</tr>
<tr>
<td>STOPPED</td>
<td>已停止（仅周期扣费）</td>
</tr>
</tbody></table>
<h2 id="4-API接口"><a href="#4-API接口" class="headerlink" title="4. API接口"></a>4. API接口</h2><h3 id="4-1-执行扣费"><a href="#4-1-执行扣费" class="headerlink" title="4.1 执行扣费"></a>4.1 执行扣费</h3><p><strong>接口路径：</strong> POST &#x2F;admin-api&#x2F;pay&#x2F;deduction&#x2F;api&#x2F;deduct</p>
<p><strong>请求参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>orderNo</td>
<td>String</td>
<td>是</td>
<td>订单号，全局唯一</td>
</tr>
<tr>
<td>userId</td>
<td>Long</td>
<td>是</td>
<td>用户ID</td>
</tr>
<tr>
<td>instanceId</td>
<td>String</td>
<td>否</td>
<td>实例ID（算力订单必填）</td>
</tr>
<tr>
<td>deductionType</td>
<td>String</td>
<td>是</td>
<td>扣费类型：MONTHLY_PREPAID&#x2F;HOURLY_POSTPAID</td>
</tr>
<tr>
<td>billingType</td>
<td>String</td>
<td>是</td>
<td>计费方式：MONTHLY&#x2F;HOURLY</td>
</tr>
<tr>
<td>amount</td>
<td>BigDecimal</td>
<td>是</td>
<td>扣费金额</td>
</tr>
<tr>
<td>unitPrice</td>
<td>BigDecimal</td>
<td>否</td>
<td>单价（周期扣费时必填）</td>
</tr>
<tr>
<td>durationHours</td>
<td>BigDecimal</td>
<td>否</td>
<td>时长（小时）</td>
</tr>
<tr>
<td>isPeriodic</td>
<td>Boolean</td>
<td>否</td>
<td>是否周期扣费，默认false</td>
</tr>
<tr>
<td>periodHours</td>
<td>Integer</td>
<td>否</td>
<td>扣费周期（小时），默认1</td>
</tr>
<tr>
<td>totalPeriods</td>
<td>Integer</td>
<td>否</td>
<td>总扣费次数，-1表示无限</td>
</tr>
</tbody></table>
<p><strong>响应参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>success</td>
<td>Boolean</td>
<td>是否成功</td>
</tr>
<tr>
<td>deductionNo</td>
<td>String</td>
<td>扣费单号</td>
</tr>
<tr>
<td>orderNo</td>
<td>String</td>
<td>订单号</td>
</tr>
<tr>
<td>amount</td>
<td>BigDecimal</td>
<td>扣费金额</td>
</tr>
<tr>
<td>deductionTime</td>
<td>LocalDateTime</td>
<td>扣费时间</td>
</tr>
<tr>
<td>failReason</td>
<td>String</td>
<td>失败原因</td>
</tr>
</tbody></table>
<p><strong>请求示例：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;orderNo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ORDER_20251210_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;instanceId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;INS_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;deductionType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HOURLY_POSTPAID&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;billingType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HOURLY&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;amount&quot;</span><span class="punctuation">:</span> <span class="number">10.00</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;unitPrice&quot;</span><span class="punctuation">:</span> <span class="number">10.00</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;durationHours&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;isPeriodic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;periodHours&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;totalPeriods&quot;</span><span class="punctuation">:</span> <span class="number">-1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>响应示例：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deductionNo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DED1998573950626086912&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;orderNo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ORDER_20251210_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;amount&quot;</span><span class="punctuation">:</span> <span class="number">10.00</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deductionTime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-10T10:09:04&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;成功&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-按订单号退款"><a href="#4-2-按订单号退款" class="headerlink" title="4.2 按订单号退款"></a>4.2 按订单号退款</h3><p><strong>接口路径：</strong> POST &#x2F;admin-api&#x2F;pay&#x2F;deduction&#x2F;api&#x2F;refund-by-order</p>
<p><strong>请求参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>orderNo</td>
<td>String</td>
<td>是</td>
<td>订单号</td>
</tr>
<tr>
<td>reason</td>
<td>String</td>
<td>是</td>
<td>退款原因</td>
</tr>
</tbody></table>
<p><strong>响应参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>success</td>
<td>Boolean</td>
<td>是否成功</td>
</tr>
<tr>
<td>orderNo</td>
<td>String</td>
<td>订单号</td>
</tr>
<tr>
<td>refundAmount</td>
<td>BigDecimal</td>
<td>退款金额</td>
</tr>
<tr>
<td>refundTime</td>
<td>LocalDateTime</td>
<td>退款时间</td>
</tr>
<tr>
<td>failReason</td>
<td>String</td>
<td>失败原因</td>
</tr>
</tbody></table>
<p><strong>说明：</strong></p>
<ul>
<li>退还该订单下所有已扣费且未退款的金额</li>
<li>周期扣费会自动停止</li>
<li>支持重复调用（幂等）</li>
</ul>
<h3 id="4-3-按扣费单号退款"><a href="#4-3-按扣费单号退款" class="headerlink" title="4.3 按扣费单号退款"></a>4.3 按扣费单号退款</h3><p><strong>接口路径：</strong> POST &#x2F;admin-api&#x2F;pay&#x2F;deduction&#x2F;api&#x2F;refund-by-deduction</p>
<p><strong>请求参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>deductionNo</td>
<td>String</td>
<td>是</td>
<td>扣费单号</td>
</tr>
<tr>
<td>reason</td>
<td>String</td>
<td>是</td>
<td>退款原因</td>
</tr>
</tbody></table>
<p><strong>响应参数：</strong> 同4.2</p>
<p><strong>说明：</strong></p>
<ul>
<li>只退还指定扣费单的金额</li>
<li>适用于部分订单退款场景</li>
</ul>
<h3 id="4-4-部分退款"><a href="#4-4-部分退款" class="headerlink" title="4.4 部分退款"></a>4.4 部分退款</h3><p><strong>接口路径：</strong> POST &#x2F;admin-api&#x2F;pay&#x2F;deduction&#x2F;api&#x2F;partial-refund</p>
<p><strong>请求参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>deductionNo</td>
<td>String</td>
<td>是</td>
<td>扣费单号</td>
</tr>
<tr>
<td>refundAmount</td>
<td>BigDecimal</td>
<td>是</td>
<td>退款金额</td>
</tr>
<tr>
<td>reason</td>
<td>String</td>
<td>是</td>
<td>退款原因</td>
</tr>
</tbody></table>
<p><strong>响应参数：</strong> 同4.2</p>
<p><strong>说明：</strong></p>
<ul>
<li>只退款指定金额</li>
<li>退款金额不能超过可退金额</li>
<li>可退金额 &#x3D; 已扣金额 - 已退金额</li>
</ul>
<h3 id="4-5-按订单号停止周期扣费"><a href="#4-5-按订单号停止周期扣费" class="headerlink" title="4.5 按订单号停止周期扣费"></a>4.5 按订单号停止周期扣费</h3><p><strong>接口路径：</strong> POST &#x2F;admin-api&#x2F;pay&#x2F;deduction&#x2F;api&#x2F;stop-periodic-by-order</p>
<p><strong>请求参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>orderNo</td>
<td>String</td>
<td>是</td>
<td>订单号</td>
</tr>
</tbody></table>
<p><strong>响应参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>data</td>
<td>Boolean</td>
<td>是否成功</td>
</tr>
</tbody></table>
<p><strong>说明：</strong></p>
<ul>
<li>停止该订单的周期扣费</li>
<li>不影响已扣费的金额</li>
<li>非周期扣费调用会返回失败</li>
</ul>
<h3 id="4-6-按扣费单号停止周期扣费"><a href="#4-6-按扣费单号停止周期扣费" class="headerlink" title="4.6 按扣费单号停止周期扣费"></a>4.6 按扣费单号停止周期扣费</h3><p><strong>接口路径：</strong> POST &#x2F;admin-api&#x2F;pay&#x2F;deduction&#x2F;api&#x2F;stop-periodic-by-deduction</p>
<p><strong>请求参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>deductionNo</td>
<td>String</td>
<td>是</td>
<td>扣费单号</td>
</tr>
</tbody></table>
<p><strong>响应参数：</strong> 同4.5</p>
<h2 id="5-典型场景"><a href="#5-典型场景" class="headerlink" title="5. 典型场景"></a>5. 典型场景</h2><h3 id="5-1-场景1：用户购买包月算力"><a href="#5-1-场景1：用户购买包月算力" class="headerlink" title="5.1 场景1：用户购买包月算力"></a>5.1 场景1：用户购买包月算力</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 创建订单</span></span><br><span class="line"><span class="type">String</span> <span class="variable">orderNo</span> <span class="operator">=</span> orderService.createOrder(userId, specId, <span class="number">1</span>, <span class="string">&quot;MONTHLY&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 执行一次性扣费</span></span><br><span class="line"><span class="type">DeductionRequestDTO</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeductionRequestDTO</span>();</span><br><span class="line">request.setOrderNo(orderNo);</span><br><span class="line">request.setUserId(userId);</span><br><span class="line">request.setInstanceId(instanceId);</span><br><span class="line">request.setDeductionType(<span class="string">&quot;MONTHLY_PREPAID&quot;</span>);</span><br><span class="line">request.setBillingType(<span class="string">&quot;MONTHLY&quot;</span>);</span><br><span class="line">request.setAmount(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;100.00&quot;</span>));</span><br><span class="line">request.setUnitPrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;100.00&quot;</span>));</span><br><span class="line">request.setDurationHours(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;720&quot;</span>)); <span class="comment">// 30天</span></span><br><span class="line">request.setIsPeriodic(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">CommonResult&lt;DeductionResultDTO&gt; result = deductionApi.deduct(request);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 保存扣费单号</span></span><br><span class="line"><span class="keyword">if</span> (result.isSuccess() &amp;&amp; result.getData().getSuccess()) &#123;</span><br><span class="line">    orderService.updateDeductionNo(orderNo, result.getData().getDeductionNo());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-场景2：用户购买按小时算力"><a href="#5-2-场景2：用户购买按小时算力" class="headerlink" title="5.2 场景2：用户购买按小时算力"></a>5.2 场景2：用户购买按小时算力</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 创建订单</span></span><br><span class="line"><span class="type">String</span> <span class="variable">orderNo</span> <span class="operator">=</span> orderService.createOrder(userId, specId, <span class="number">1</span>, <span class="string">&quot;HOURLY&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 执行首次扣费（后续由定时任务自动续扣）</span></span><br><span class="line"><span class="type">DeductionRequestDTO</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeductionRequestDTO</span>();</span><br><span class="line">request.setOrderNo(orderNo);</span><br><span class="line">request.setUserId(userId);</span><br><span class="line">request.setInstanceId(instanceId);</span><br><span class="line">request.setDeductionType(<span class="string">&quot;HOURLY_POSTPAID&quot;</span>);</span><br><span class="line">request.setBillingType(<span class="string">&quot;HOURLY&quot;</span>);</span><br><span class="line">request.setAmount(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;10.00&quot;</span>));</span><br><span class="line">request.setUnitPrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;10.00&quot;</span>));</span><br><span class="line">request.setDurationHours(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;1&quot;</span>));</span><br><span class="line">request.setIsPeriodic(<span class="literal">true</span>);</span><br><span class="line">request.setPeriodHours(<span class="number">1</span>);</span><br><span class="line">request.setTotalPeriods(-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">CommonResult&lt;DeductionResultDTO&gt; result = deductionApi.deduct(request);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 保存扣费单号</span></span><br><span class="line"><span class="keyword">if</span> (result.isSuccess() &amp;&amp; result.getData().getSuccess()) &#123;</span><br><span class="line">    orderService.updateDeductionNo(orderNo, result.getData().getDeductionNo());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 订阅余额预警消息（自动监控，无需额外操作）</span></span><br><span class="line"><span class="comment">// 扣费系统会自动监控余额，在余额不足时发送预警消息</span></span><br><span class="line"><span class="comment">// 订单系统只需监听消息队列即可（见7.4节）</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-场景3：用户申请退款"><a href="#5-3-场景3：用户申请退款" class="headerlink" title="5.3 场景3：用户申请退款"></a>5.3 场景3：用户申请退款</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 停止周期扣费（如果是按小时计费）</span></span><br><span class="line"><span class="keyword">if</span> (order.getBillingType().equals(<span class="string">&quot;HOURLY&quot;</span>)) &#123;</span><br><span class="line">    deductionApi.stopPeriodicDeductionByOrderNo(orderNo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 执行退款</span></span><br><span class="line">CommonResult&lt;RefundResultDTO&gt; result = deductionApi.refundByOrderNo(orderNo, <span class="string">&quot;用户申请退款&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 更新订单状态</span></span><br><span class="line"><span class="keyword">if</span> (result.isSuccess() &amp;&amp; result.getData().getSuccess()) &#123;</span><br><span class="line">    orderService.updateRefundStatus(orderNo, result.getData().getRefundAmount());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-场景4：用户释放实例"><a href="#5-4-场景4：用户释放实例" class="headerlink" title="5.4 场景4：用户释放实例"></a>5.4 场景4：用户释放实例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 停止周期扣费</span></span><br><span class="line">CommonResult&lt;Boolean&gt; stopResult = deductionApi.stopPeriodicDeductionByOrderNo(orderNo);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 更新实例状态</span></span><br><span class="line"><span class="keyword">if</span> (stopResult.isSuccess() &amp;&amp; stopResult.getData()) &#123;</span><br><span class="line">    instanceService.updateStatus(instanceId, <span class="string">&quot;RELEASED&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-5-场景5：订单升降配"><a href="#5-5-场景5：订单升降配" class="headerlink" title="5.5 场景5：订单升降配"></a>5.5 场景5：订单升降配</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 停止旧配置的扣费</span></span><br><span class="line">deductionApi.stopPeriodicDeductionByOrderNo(oldOrderNo);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 创建新订单并开始扣费</span></span><br><span class="line"><span class="type">String</span> <span class="variable">newOrderNo</span> <span class="operator">=</span> orderService.createOrder(userId, newSpecId, <span class="number">1</span>, <span class="string">&quot;HOURLY&quot;</span>);</span><br><span class="line"><span class="type">DeductionRequestDTO</span> <span class="variable">request</span> <span class="operator">=</span> buildDeductionRequest(newOrderNo, newSpecId);</span><br><span class="line">deductionApi.deduct(request);</span><br></pre></td></tr></table></figure>

<h3 id="5-6-场景6：处理余额预警"><a href="#5-6-场景6：处理余额预警" class="headerlink" title="5.6 场景6：处理余额预警"></a>5.6 场景6：处理余额预警</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 余额预警消息消费者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BalanceWarningConsumer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> NotificationService notificationService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;deduction.balance.warning.queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleBalanceWarning</span><span class="params">(BalanceWarningMessage message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;[余额预警] orderNo: &#123;&#125;, warningLevel: &#123;&#125;&quot;</span>, </span><br><span class="line">                message.getOrderNo(), message.getWarningLevel());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 查询订单信息</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.getOrderByNo(message.getOrderNo());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 计算剩余可用时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">remainingHours</span> <span class="operator">=</span> (<span class="type">long</span>) message.getRemainingPeriods() * message.getPeriodHours();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 根据预警级别发送不同通知</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;1day&quot;</span>.equals(message.getWarningLevel())) &#123;</span><br><span class="line">            <span class="comment">// 紧急预警：发送短信</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> String.format(</span><br><span class="line">                <span class="string">&quot;【紧急】您的订单%s余额即将耗尽（剩余%d小时），请尽快充值！&quot;</span>,</span><br><span class="line">                order.getOrderName(), remainingHours</span><br><span class="line">            );</span><br><span class="line">            notificationService.sendSms(message.getUserId(), content);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 普通预警：发送站内信</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> String.format(</span><br><span class="line">                <span class="string">&quot;您的订单%s余额预计%d天后耗尽，建议及时充值。&quot;</span>,</span><br><span class="line">                order.getOrderName(), remainingHours / <span class="number">24</span></span><br><span class="line">            );</span><br><span class="line">            notificationService.sendInApp(message.getUserId(), content);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 记录预警历史</span></span><br><span class="line">        orderService.saveWarningHistory(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-消息推送"><a href="#6-消息推送" class="headerlink" title="6. 消息推送"></a>6. 消息推送</h2><p>扣费系统通过RabbitMQ推送以下消息，订单系统可订阅相关消息：</p>
<h3 id="6-1-扣费结果消息"><a href="#6-1-扣费结果消息" class="headerlink" title="6.1 扣费结果消息"></a>6.1 扣费结果消息</h3><p><strong>Exchange:</strong> pay.deduction<br><strong>RoutingKey:</strong> pay.deduction.result<br><strong>消息体：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;deductionNo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DED1998573950626086912&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;orderNo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ORDER_20251210_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;amount&quot;</span><span class="punctuation">:</span> <span class="number">10.00</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;failReason&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;deductionTime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-10T10:09:04&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-余额预警消息"><a href="#6-2-余额预警消息" class="headerlink" title="6.2 余额预警消息"></a>6.2 余额预警消息</h3><p><strong>Exchange:</strong> pay.deduction<br><strong>RoutingKey:</strong> pay.deduction.balance.warning<br><strong>消息体：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;orderNo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ORDER_20251210_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;instanceId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;INS_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;currentBalance&quot;</span><span class="punctuation">:</span> <span class="number">100.00</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;unitPrice&quot;</span><span class="punctuation">:</span> <span class="number">10.00</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;remainingPeriods&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;periodHours&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;estimatedDepletionTime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-12T10:00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;warningTime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-09T10:00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;warningLevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3days&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>预警级别说明：</strong></p>
<ul>
<li><code>3days</code>: 提前3天预警（剩余时间 ≤ 72小时）</li>
<li><code>1day</code>: 提前1天预警（剩余时间 ≤ 24小时）</li>
</ul>
<p><strong>预警机制：</strong></p>
<ul>
<li>定时任务每小时检查一次所有活跃的周期扣费订单</li>
<li>根据当前余额和扣费周期计算剩余可用时间</li>
<li>达到预警阈值时发送预警消息（通过Redis去重，避免重复发送）</li>
</ul>
<p><strong>处理建议：</strong></p>
<ul>
<li>发送站内信或短信通知用户充值</li>
<li>根据预警级别设置不同的通知优先级（1天预警更紧急）</li>
<li>记录预警历史，用于后续分析</li>
<li>用户充值后预警自动解除</li>
</ul>
<h3 id="6-3-余额不足消息"><a href="#6-3-余额不足消息" class="headerlink" title="6.3 余额不足消息"></a>6.3 余额不足消息</h3><p><strong>Exchange:</strong> pay.deduction<br><strong>RoutingKey:</strong> pay.deduction.balance.insufficient<br><strong>消息体：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;deductionNo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DED1998573950626086912&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;orderNo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ORDER_20251210_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;requiredAmount&quot;</span><span class="punctuation">:</span> <span class="number">10.00</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;currentBalance&quot;</span><span class="punctuation">:</span> <span class="number">5.00</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;instanceId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;INS_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;checkTime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-10T10:09:04&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>处理建议：</strong></p>
<ul>
<li>发送站内信或短信通知用户</li>
<li>立即暂停或关闭用户实例</li>
<li>记录欠费状态</li>
<li>周期扣费已自动停止，无需再次调用停止接口</li>
</ul>
<h3 id="6-4-退款结果消息"><a href="#6-4-退款结果消息" class="headerlink" title="6.4 退款结果消息"></a>6.4 退款结果消息</h3><p><strong>Exchange:</strong> pay.deduction<br><strong>RoutingKey:</strong> pay.deduction.refund.result<br><strong>消息体：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;orderNo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ORDER_20251210_001&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;refundAmount&quot;</span><span class="punctuation">:</span> <span class="number">50.00</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;refundTime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-12-10T10:09:04&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="7-余额预警系统"><a href="#7-余额预警系统" class="headerlink" title="7. 余额预警系统"></a>7. 余额预警系统</h2><blockquote>
<p><strong>重要说明</strong>：余额预警系统是自动运行的，订单系统<strong>无需主动调用任何接口</strong>，只需要订阅消息队列接收预警通知即可。</p>
</blockquote>
<h3 id="7-1-预警机制说明"><a href="#7-1-预警机制说明" class="headerlink" title="7.1 预警机制说明"></a>7.1 预警机制说明</h3><p>扣费系统内置了余额预警功能，会提前通知用户余额不足，避免服务突然中断。</p>
<p><strong>两级预警策略：</strong></p>
<table>
<thead>
<tr>
<th>预警级别</th>
<th>触发条件</th>
<th>预警时间</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>一级预警</td>
<td>剩余时间 ≤ 72小时</td>
<td>提前3天</td>
<td>温馨提醒用户充值</td>
</tr>
<tr>
<td>二级预警</td>
<td>剩余时间 ≤ 24小时</td>
<td>提前1天</td>
<td>紧急通知用户充值</td>
</tr>
</tbody></table>
<p><strong>计算公式：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">剩余可扣费次数 = 当前余额 / 单次扣费金额（向下取整）</span><br><span class="line">剩余可用时间 = 剩余可扣费次数 × 扣费周期（小时）</span><br></pre></td></tr></table></figure>

<p><strong>示例：</strong></p>
<ul>
<li>当前余额：100元</li>
<li>每小时扣费：10元</li>
<li>剩余可用时间：10小时</li>
<li>触发级别：二级预警（1天预警）</li>
</ul>
<h3 id="7-2-预警触发方式"><a href="#7-2-预警触发方式" class="headerlink" title="7.2 预警触发方式"></a>7.2 预警触发方式</h3><p><strong>1. 定时扫描（主要方式）</strong></p>
<ul>
<li>定时任务每小时扫描所有活跃的周期扣费订单</li>
<li>计算每个订单的剩余可用时间</li>
<li>达到预警阈值时自动发送预警消息</li>
</ul>
<p><strong>2. 实时检查（辅助方式）</strong></p>
<ul>
<li>在执行周期扣费前实时检查余额</li>
<li>如果剩余时间不足1天，立即发送预警</li>
<li>确保及时通知用户</li>
</ul>
<h3 id="7-3-预警去重机制"><a href="#7-3-预警去重机制" class="headerlink" title="7.3 预警去重机制"></a>7.3 预警去重机制</h3><p><strong>Redis去重：</strong></p>
<ul>
<li>使用Redis记录每个订单的预警状态</li>
<li>Redis Key格式：<ul>
<li>3天预警：<code>balance:warning:3days:{orderNo}</code></li>
<li>1天预警：<code>balance:warning:1day:{orderNo}</code></li>
</ul>
</li>
<li>预警记录有效期：4天</li>
<li>同一订单在4天内不会重复发送相同级别的预警</li>
</ul>
<p><strong>多级预警：</strong></p>
<ul>
<li>3天预警和1天预警独立记录</li>
<li>用户可能先收到3天预警，3天后再收到1天预警</li>
<li>如果用户充值后余额恢复，预警会在4天后自动过期</li>
</ul>
<h3 id="7-4-订单系统如何使用"><a href="#7-4-订单系统如何使用" class="headerlink" title="7.4 订单系统如何使用"></a>7.4 订单系统如何使用</h3><p><strong>预警系统是自动运行的，订单系统无需主动调用</strong>，只需要订阅消息并处理即可。</p>
<h4 id="使用流程"><a href="#使用流程" class="headerlink" title="使用流程"></a>使用流程</h4><pre class="mermaid">graph LR
    A[订单系统创建订单] --> B[调用扣费接口]
    B --> C[扣费系统自动监控]
    C --> D[定时任务检查余额]
    D --> E{余额不足?}
    E -->|是| F[发送预警消息]
    F --> G[订单系统接收消息]
    G --> H[通知用户充值]
    E -->|否| D</pre>

<h4 id="第1步：创建RabbitMQ消费者"><a href="#第1步：创建RabbitMQ消费者" class="headerlink" title="第1步：创建RabbitMQ消费者"></a>第1步：创建RabbitMQ消费者</h4><p>在订单系统中创建消费者监听预警消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ksxzcx.cloud.<span class="keyword">module</span>.order.mq.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.ksxzcx.cloud.<span class="keyword">module</span>.pay.mq.message.BalanceWarningMessage;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 余额预警消息消费者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BalanceWarningConsumer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> NotificationService notificationService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SmsService smsService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理余额预警消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;deduction.balance.warning.queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleBalanceWarning</span><span class="params">(BalanceWarningMessage message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;[余额预警] 用户: &#123;&#125;, 订单: &#123;&#125;, 预警级别: &#123;&#125;, 剩余可用时长: &#123;&#125;小时&quot;</span>, </span><br><span class="line">                message.getUserId(), </span><br><span class="line">                message.getOrderNo(), </span><br><span class="line">                message.getWarningLevel(),</span><br><span class="line">                message.getRemainingPeriods() * message.getPeriodHours());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 查询订单信息</span></span><br><span class="line">            <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.getOrderByNo(message.getOrderNo());</span><br><span class="line">            <span class="keyword">if</span> (order == <span class="literal">null</span>) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;[余额预警][订单不存在] orderNo: &#123;&#125;&quot;</span>, message.getOrderNo());</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 根据预警级别发送不同通知</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;1day&quot;</span>.equals(message.getWarningLevel())) &#123;</span><br><span class="line">                <span class="comment">// 1天预警：更紧急，发送短信+站内信</span></span><br><span class="line">                sendUrgentNotification(message, order);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;3days&quot;</span>.equals(message.getWarningLevel())) &#123;</span><br><span class="line">                <span class="comment">// 3天预警：发送站内信+邮件</span></span><br><span class="line">                sendNormalNotification(message, order);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 记录预警历史（用于后续分析）</span></span><br><span class="line">            orderService.saveWarningHistory(message);</span><br><span class="line">            </span><br><span class="line">            log.info(<span class="string">&quot;[余额预警][处理完成] orderNo: &#123;&#125;&quot;</span>, message.getOrderNo());</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[余额预警][处理失败] orderNo: &#123;&#125;, userId: &#123;&#125;&quot;</span>, </span><br><span class="line">                    message.getOrderNo(), message.getUserId(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送紧急通知（1天预警）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendUrgentNotification</span><span class="params">(BalanceWarningMessage message, Order order)</span> &#123;</span><br><span class="line">        <span class="comment">// 计算剩余时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">remainingHours</span> <span class="operator">=</span> (<span class="type">long</span>) message.getRemainingPeriods() * message.getPeriodHours();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 发送短信</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">smsContent</span> <span class="operator">=</span> String.format(</span><br><span class="line">            <span class="string">&quot;【算力平台】尊敬的用户，您的订单%s余额即将耗尽（预计剩余%d小时），请及时充值以免服务中断。&quot;</span>,</span><br><span class="line">            order.getOrderName(),</span><br><span class="line">            remainingHours</span><br><span class="line">        );</span><br><span class="line">        smsService.sendSms(message.getUserId(), smsContent);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 发送站内信</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">notificationContent</span> <span class="operator">=</span> String.format(</span><br><span class="line">            <span class="string">&quot;您的订单【%s】余额预警\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;当前余额：%.2f元\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;预计剩余时长：%d小时\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;预计耗尽时间：%s\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;为避免服务中断，请及时充值。&quot;</span>,</span><br><span class="line">            order.getOrderName(),</span><br><span class="line">            message.getCurrentBalance(),</span><br><span class="line">            remainingHours,</span><br><span class="line">            message.getEstimatedDepletionTime()</span><br><span class="line">        );</span><br><span class="line">        notificationService.sendWithAction(</span><br><span class="line">            message.getUserId(), </span><br><span class="line">            <span class="string">&quot;余额预警&quot;</span>, </span><br><span class="line">            notificationContent,</span><br><span class="line">            <span class="string">&quot;立即充值&quot;</span>,</span><br><span class="line">            <span class="string">&quot;/recharge&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送普通通知（3天预警）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendNormalNotification</span><span class="params">(BalanceWarningMessage message, Order order)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">remainingHours</span> <span class="operator">=</span> (<span class="type">long</span>) message.getRemainingPeriods() * message.getPeriodHours();</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> String.format(</span><br><span class="line">            <span class="string">&quot;您的订单【%s】余额提醒\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;当前余额：%.2f元\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;预计剩余时长：%d小时（约%d天）\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;建议您及时充值，避免服务中断。&quot;</span>,</span><br><span class="line">            order.getOrderName(),</span><br><span class="line">            message.getCurrentBalance(),</span><br><span class="line">            remainingHours,</span><br><span class="line">            remainingHours / <span class="number">24</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        notificationService.send(message.getUserId(), <span class="string">&quot;余额提醒&quot;</span>, content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第2步：配置RabbitMQ队列"><a href="#第2步：配置RabbitMQ队列" class="headerlink" title="第2步：配置RabbitMQ队列"></a>第2步：配置RabbitMQ队列</h4><p>确保订单系统的配置文件中包含RabbitMQ配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br></pre></td></tr></table></figure>

<p>队列已经由扣费系统自动创建，订单系统只需要监听即可。</p>
<h4 id="第3步：处理预警后的业务逻辑"><a href="#第3步：处理预警后的业务逻辑" class="headerlink" title="第3步：处理预警后的业务逻辑"></a>第3步：处理预警后的业务逻辑</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存预警历史</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveWarningHistory</span><span class="params">(BalanceWarningMessage message)</span> &#123;</span><br><span class="line">        <span class="type">OrderWarningHistory</span> <span class="variable">history</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderWarningHistory</span>();</span><br><span class="line">        history.setOrderNo(message.getOrderNo());</span><br><span class="line">        history.setUserId(message.getUserId());</span><br><span class="line">        history.setWarningLevel(message.getWarningLevel());</span><br><span class="line">        history.setCurrentBalance(message.getCurrentBalance());</span><br><span class="line">        history.setRemainingPeriods(message.getRemainingPeriods());</span><br><span class="line">        history.setEstimatedDepletionTime(message.getEstimatedDepletionTime());</span><br><span class="line">        history.setWarningTime(message.getWarningTime());</span><br><span class="line">        </span><br><span class="line">        orderWarningHistoryMapper.insert(history);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户充值后，预警会自动解除</span></span><br><span class="line"><span class="comment">     * 无需手动处理，4天后Redis自动过期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第4步：前端展示（可选）"><a href="#第4步：前端展示（可选）" class="headerlink" title="第4步：前端展示（可选）"></a>第4步：前端展示（可选）</h4><p>在订单详情页展示余额预警信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/order/&#123;orderNo&#125;/balance-status&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResult&lt;BalanceStatusVO&gt; <span class="title function_">getBalanceStatus</span><span class="params">(<span class="meta">@PathVariable</span> String orderNo)</span> &#123;</span><br><span class="line">    <span class="comment">// 查询最近的预警记录</span></span><br><span class="line">    <span class="type">OrderWarningHistory</span> <span class="variable">latestWarning</span> <span class="operator">=</span> orderService.getLatestWarning(orderNo);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (latestWarning == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> success(BalanceStatusVO.normal());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">BalanceStatusVO</span> <span class="variable">vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BalanceStatusVO</span>();</span><br><span class="line">    vo.setHasWarning(<span class="literal">true</span>);</span><br><span class="line">    vo.setWarningLevel(latestWarning.getWarningLevel());</span><br><span class="line">    vo.setRemainingHours(latestWarning.getRemainingPeriods() * periodHours);</span><br><span class="line">    vo.setEstimatedDepletionTime(latestWarning.getEstimatedDepletionTime());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> success(vo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>方式2：监听余额不足消息</strong></p>
<p>余额不足导致扣费失败时，也会停止周期扣费并发送余额不足消息（见6.3节）</p>
<h3 id="7-5-预警消息字段说明"><a href="#7-5-预警消息字段说明" class="headerlink" title="7.5 预警消息字段说明"></a>7.5 预警消息字段说明</h3><table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>userId</td>
<td>Long</td>
<td>是</td>
<td>用户ID</td>
<td>1</td>
</tr>
<tr>
<td>orderNo</td>
<td>String</td>
<td>是</td>
<td>订单号</td>
<td>ORDER_20251210_001</td>
</tr>
<tr>
<td>instanceId</td>
<td>String</td>
<td>否</td>
<td>实例ID（算力订单）</td>
<td>INS_001</td>
</tr>
<tr>
<td>currentBalance</td>
<td>BigDecimal</td>
<td>是</td>
<td>当前余额（元）</td>
<td>100.00</td>
</tr>
<tr>
<td>unitPrice</td>
<td>BigDecimal</td>
<td>是</td>
<td>单次扣费金额（元）</td>
<td>10.00</td>
</tr>
<tr>
<td>remainingPeriods</td>
<td>Integer</td>
<td>是</td>
<td>剩余可扣费次数</td>
<td>10</td>
</tr>
<tr>
<td>periodHours</td>
<td>Integer</td>
<td>是</td>
<td>扣费周期（小时）</td>
<td>1</td>
</tr>
<tr>
<td>estimatedDepletionTime</td>
<td>LocalDateTime</td>
<td>是</td>
<td>预计余额耗尽时间</td>
<td>2025-12-12T10:00:00</td>
</tr>
<tr>
<td>warningTime</td>
<td>LocalDateTime</td>
<td>是</td>
<td>预警时间</td>
<td>2025-12-09T10:00:00</td>
</tr>
<tr>
<td>warningLevel</td>
<td>String</td>
<td>是</td>
<td>预警级别</td>
<td>“3days” 或 “1day”</td>
</tr>
</tbody></table>
<p><strong>字段说明：</strong></p>
<ol>
<li><strong>remainingPeriods</strong>：剩余可扣费次数 &#x3D; 当前余额 &#x2F; 单次扣费金额（向下取整）</li>
<li><strong>estimatedDepletionTime</strong>：预计余额耗尽时间 &#x3D; 当前时间 + (剩余次数 × 扣费周期)</li>
<li><strong>warningLevel</strong>：<ul>
<li><code>&quot;3days&quot;</code>：剩余时间 ≤ 72小时</li>
<li><code>&quot;1day&quot;</code>：剩余时间 ≤ 24小时</li>
</ul>
</li>
</ol>
<p><strong>计算示例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">当前余额：100元</span><br><span class="line">单次扣费：10元/小时</span><br><span class="line">扣费周期：1小时</span><br><span class="line"></span><br><span class="line">剩余可扣费次数 = 100 / 10 = 10次</span><br><span class="line">剩余可用时间 = 10 × 1 = 10小时</span><br><span class="line">预计耗尽时间 = 当前时间 + 10小时</span><br><span class="line">预警级别 = &quot;1day&quot;（因为10小时 &lt; 24小时）</span><br></pre></td></tr></table></figure>

<h3 id="7-6-预警系统配置"><a href="#7-6-预警系统配置" class="headerlink" title="7.6 预警系统配置"></a>7.6 预警系统配置</h3><p><strong>定时任务配置（XXL-Job）：</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">任务名称</span>: <span class="string">balanceWarningJob</span></span><br><span class="line"><span class="attr">任务描述</span>: <span class="string">余额预警定时任务</span></span><br><span class="line"><span class="attr">Cron表达式</span>: <span class="string">0 0 * * * ?  # 每小时执行一次</span></span><br><span class="line"><span class="attr">JobHandler</span>: <span class="string">balanceWarningJob</span></span><br><span class="line"><span class="attr">运行模式</span>: <span class="string">BEAN</span></span><br><span class="line"><span class="attr">路由策略</span>: <span class="string">第一个</span></span><br><span class="line"><span class="attr">阻塞处理策略</span>: <span class="string">单机串行</span></span><br><span class="line"><span class="attr">任务超时时间</span>: <span class="string">300秒</span></span><br><span class="line"><span class="attr">失败重试次数</span>: <span class="string">3</span></span><br></pre></td></tr></table></figure>

<p><strong>Redis配置：</strong></p>
<p>确保Redis正常连接，用于预警去重：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="7-7-重要说明"><a href="#7-7-重要说明" class="headerlink" title="7.7 重要说明"></a>7.7 重要说明</h3><p><strong>1. 预警系统完全自动运行</strong></p>
<ul>
<li>订单系统无需主动调用任何预警接口</li>
<li>只需订阅消息队列即可接收预警</li>
<li>扣费系统会自动监控并发送预警</li>
</ul>
<p><strong>2. 预警不会重复发送</strong></p>
<ul>
<li>通过Redis确保同一订单4天内不会重复发送相同级别的预警</li>
<li>用户充值后，预警标记会在4天后自动过期</li>
<li>如果余额再次不足，会重新触发预警</li>
</ul>
<p><strong>3. 预警与扣费失败的区别</strong></p>
<ul>
<li><strong>预警</strong>：余额充足，但即将不足（提前通知）</li>
<li><strong>扣费失败</strong>：余额不足，扣费已经失败（事后通知）</li>
<li>建议同时监听两种消息，提供最佳用户体验</li>
</ul>
<p><strong>4. 预警消息包含的关键信息</strong></p>
<ul>
<li>当前余额</li>
<li>剩余可扣费次数</li>
<li>预计余额耗尽时间</li>
<li>预警级别（3天&#x2F;1天）</li>
</ul>
<h3 id="7-8-最佳实践"><a href="#7-8-最佳实践" class="headerlink" title="7.8 最佳实践"></a>7.8 最佳实践</h3><p><strong>1. 通知优先级建议</strong></p>
<table>
<thead>
<tr>
<th>预警级别</th>
<th>通知方式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>3天预警</td>
<td>站内信 + 邮件</td>
<td>温馨提醒，不打扰用户</td>
</tr>
<tr>
<td>1天预警</td>
<td>站内信 + 短信 + 邮件</td>
<td>紧急通知，确保用户看到</td>
</tr>
</tbody></table>
<p><strong>2. 通知内容建议</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">【3天预警】</span><br><span class="line">标题：余额提醒</span><br><span class="line">内容：您的订单【xxx】预计3天后余额耗尽，建议您及时充值。</span><br><span class="line">按钮：[查看详情] [立即充值]</span><br><span class="line"></span><br><span class="line">【1天预警】</span><br><span class="line">标题：余额紧急提醒</span><br><span class="line">内容：您的订单【xxx】预计24小时后余额耗尽，请尽快充值以免服务中断！</span><br><span class="line">按钮：[立即充值]</span><br></pre></td></tr></table></figure>

<p><strong>3. 用户行为引导</strong></p>
<ul>
<li>在通知中提供快速充值链接</li>
<li>显示预计余额耗尽的具体时间</li>
<li>说明充值后服务将继续正常运行</li>
<li>提供充值优惠信息（可选）</li>
</ul>
<p><strong>4. 数据统计分析</strong></p>
<ul>
<li>统计每日预警触发次数</li>
<li>分析预警后的充值转化率</li>
<li>识别经常余额不足的用户，提供自动充值方案</li>
</ul>
<p><strong>5. 监控告警</strong></p>
<ul>
<li>监控预警消息发送成功率</li>
<li>监控预警触发的订单数量</li>
<li>异常时及时告警运维人员</li>
</ul>
<p><strong>6. 异常处理</strong></p>
<ul>
<li>预警发送失败不影响扣费流程</li>
<li>记录预警失败日志，便于问题排查</li>
<li>可以设置预警补发机制（可选）</li>
</ul>
<h3 id="7-9-常见问题"><a href="#7-9-常见问题" class="headerlink" title="7.9 常见问题"></a>7.9 常见问题</h3><p><strong>Q1：预警消息会重复发送吗？</strong><br>A：不会。通过Redis确保同一订单在4天内不会重复发送相同级别的预警。</p>
<p><strong>Q2：用户充值后预警会立即解除吗？</strong><br>A：预警标记会在4天后自动过期。如果充值后余额充足，下次定时任务检查时不会再触发预警。</p>
<p><strong>Q3：为什么同时有定时扫描和实时检查？</strong><br>A：</p>
<ul>
<li>定时扫描：确保所有订单都会被检查到</li>
<li>实时检查：在扣费时立即发现余额不足，更及时</li>
</ul>
<p><strong>Q4：预警消息发送失败怎么办？</strong><br>A：预警失败不影响扣费流程。下次定时任务会重新检查，如果仍然满足条件且未发送过，会再次尝试发送。</p>
<p><strong>Q5：可以自定义预警阈值吗？</strong><br>A：当前固定为3天和1天。如需自定义，可以在 <code>BalanceWarningService</code> 中修改常量。</p>
<p><strong>Q6：预警消息的优先级如何？</strong><br>A：1天预警优先级高于3天预警。如果同时满足两个条件，会优先发送1天预警。</p>
<h2 id="8-重要说明"><a href="#8-重要说明" class="headerlink" title="8. 重要说明"></a>8. 重要说明</h2><h3 id="8-1-幂等性保证"><a href="#8-1-幂等性保证" class="headerlink" title="8.1 幂等性保证"></a>8.1 幂等性保证</h3><p>所有扣费和退款接口均保证幂等性：</p>
<ul>
<li>相同订单号重复调用扣费，只会扣费一次</li>
<li>相同订单号重复调用退款，只会退款一次</li>
<li>建议在业务系统中也保存扣费单号，用于对账</li>
</ul>
<h3 id="8-2-周期扣费说明"><a href="#8-2-周期扣费说明" class="headerlink" title="8.2 周期扣费说明"></a>8.2 周期扣费说明</h3><p><strong>首次扣费：</strong></p>
<ul>
<li>调用扣费接口时立即扣费第1期</li>
<li>扣费成功后，系统会自动创建周期任务</li>
</ul>
<p><strong>续扣机制：</strong></p>
<ul>
<li>定时任务每分钟扫描需要续扣的订单</li>
<li>自动扣减余额并创建扣费明细</li>
<li>余额不足时立即停止周期扣费</li>
</ul>
<p><strong>停止扣费：</strong></p>
<ul>
<li>用户释放实例时必须调用停止接口</li>
<li>退款时会自动停止周期扣费</li>
<li>余额不足时立即自动停止</li>
</ul>
<h3 id="8-3-金额说明"><a href="#8-3-金额说明" class="headerlink" title="8.3 金额说明"></a>8.3 金额说明</h3><ul>
<li>所有金额单位：元</li>
<li>金额精度：小数点后4位（数据库DECIMAL(18,4)）</li>
<li>可退金额 &#x3D; 已扣金额 - 已退金额</li>
<li>超过4位小数的金额会被四舍五入</li>
</ul>
<h3 id="8-4-错误处理"><a href="#8-4-错误处理" class="headerlink" title="8.4 错误处理"></a>8.4 错误处理</h3><p><strong>常见错误码：</strong></p>
<table>
<thead>
<tr>
<th>错误码</th>
<th>说明</th>
<th>处理建议</th>
</tr>
</thead>
<tbody><tr>
<td>1004008001</td>
<td>余额不足</td>
<td>提示用户充值</td>
</tr>
<tr>
<td>1004008002</td>
<td>扣费记录不存在</td>
<td>检查订单号是否正确</td>
</tr>
<tr>
<td>1004008003</td>
<td>退款金额超过可退金额</td>
<td>检查退款金额</td>
</tr>
<tr>
<td>1004008004</td>
<td>不是周期扣费</td>
<td>检查扣费类型</td>
</tr>
</tbody></table>
<h2 id="9-附录"><a href="#9-附录" class="headerlink" title="9. 附录"></a>9. 附录</h2><h3 id="9-1-数据库表结构"><a href="#9-1-数据库表结构" class="headerlink" title="9.1 数据库表结构"></a>9.1 数据库表结构</h3><p><strong>主记录表：</strong> tgkw_deduction_record<br><strong>明细记录表：</strong> tgkw_deduction_detail</p>
<h3 id="9-2-测试用例"><a href="#9-2-测试用例" class="headerlink" title="9.2 测试用例"></a>9.2 测试用例</h3><p>示例请参考：</p>
<ul>
<li>tgwk-module-pay-server&#x2F;src&#x2F;test&#x2F;resources&#x2F;http&#x2F;deduction-api-test.http</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://goppop.github.io">Goppop</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://goppop.github.io/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%8E%A5%E6%96%87%E6%A1%A3/">https://goppop.github.io/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%8E%A5%E6%96%87%E6%A1%A3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://goppop.github.io" target="_blank">Goppop的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/">系统开发</a></div><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/" title="算力平台扣费系统设计方案"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">算力平台扣费系统设计方案</div></div><div class="info-2"><div class="info-item-1">算力平台扣费系统设计方案一、设计目标1.1 核心需求 包月（预付费）：一次性扣除整月费用 按小时计费（后付费）：先扣首小时费用，后续每小时自动续扣 资金安全：不重复扣、不多退 操作幂等：同一订单多次调用只生效一次 高可用 &amp; 可对账：支持故障恢复和数据核对 系统解耦：与订单&#x2F;资源系统解耦，通过消息队列异步通信  1.2 设计原则 最终一致性：允许短暂的数据不一致，通过补偿机制保证最终一致 幂等优先：所有扣费操作必须支持幂等 可追溯性：每笔扣费都有完整的流水记录 故障隔离：扣费系统故障不影响订单和资源系统   二、核心架构设计2.1 系统分层123456789101112131415161718192021222324252627282930313233343536373839404142434445┌─────────────────────────────────────────────────────────┐│                    订单系统                              ││  ┌──────────────┐...</div></div></div></a><a class="pagination-related" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" title="扣费系统使用指南"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">扣费系统使用指南</div></div><div class="info-2"><div class="info-item-1">扣费系统使用指南一、系统概述扣费系统是算力平台的核心计费模块，支持包月预付费和按小时后付费两种计费方式。系统已完全集成到 pay 模块中。 核心功能 包月扣费（预付费）：一次性扣除整月费用 按小时扣费（后付费）：首小时扣费 + 周期续扣 退款处理：订单取消或失败时的退款 定时任务：自动执行周期续扣和对账 同步调用：直接调用扣费服务，实时返回结果  二、数据库表结构1. 扣费记录表表名：tgkw_deduction_record SQL文件位置：sql/mysql/system/deduction_record.sql 执行以下SQL创建表： 12-- 在你的MySQL数据库中执行source sql/mysql/system/deduction_record.sql;  三、API接口说明1. 创建扣费接口地址： POST /admin-api/pay/deduction/create 权限： pay:deduction:create 请求示例（包月）： 1234567891011&#123;  &quot;orderNo&quot;: &quot;ORD20231201001&...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" title="扣费系统使用指南"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-10</div><div class="info-item-2">扣费系统使用指南</div></div><div class="info-2"><div class="info-item-1">扣费系统使用指南一、系统概述扣费系统是算力平台的核心计费模块，支持包月预付费和按小时后付费两种计费方式。系统已完全集成到 pay 模块中。 核心功能 包月扣费（预付费）：一次性扣除整月费用 按小时扣费（后付费）：首小时扣费 + 周期续扣 退款处理：订单取消或失败时的退款 定时任务：自动执行周期续扣和对账 同步调用：直接调用扣费服务，实时返回结果  二、数据库表结构1. 扣费记录表表名：tgkw_deduction_record SQL文件位置：sql/mysql/system/deduction_record.sql 执行以下SQL创建表： 12-- 在你的MySQL数据库中执行source sql/mysql/system/deduction_record.sql;  三、API接口说明1. 创建扣费接口地址： POST /admin-api/pay/deduction/create 权限： pay:deduction:create 请求示例（包月）： 1234567891011&#123;  &quot;orderNo&quot;: &quot;ORD20231201001&...</div></div></div></a><a class="pagination-related" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/" title="算力平台扣费系统设计方案"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-10</div><div class="info-item-2">算力平台扣费系统设计方案</div></div><div class="info-2"><div class="info-item-1">算力平台扣费系统设计方案一、设计目标1.1 核心需求 包月（预付费）：一次性扣除整月费用 按小时计费（后付费）：先扣首小时费用，后续每小时自动续扣 资金安全：不重复扣、不多退 操作幂等：同一订单多次调用只生效一次 高可用 &amp; 可对账：支持故障恢复和数据核对 系统解耦：与订单&#x2F;资源系统解耦，通过消息队列异步通信  1.2 设计原则 最终一致性：允许短暂的数据不一致，通过补偿机制保证最终一致 幂等优先：所有扣费操作必须支持幂等 可追溯性：每笔扣费都有完整的流水记录 故障隔离：扣费系统故障不影响订单和资源系统   二、核心架构设计2.1 系统分层123456789101112131415161718192021222324252627282930313233343536373839404142434445┌─────────────────────────────────────────────────────────┐│                    订单系统                              ││  ┌──────────────┐...</div></div></div></a><a class="pagination-related" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F-%E4%BB%8E%E8%AE%BE%E8%AE%A1%E5%88%B0%E5%BC%80%E5%8F%91%E5%85%A8%E8%BF%87%E7%A8%8B/" title="算力平台扣费系统：从设计到开发全过程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-10</div><div class="info-item-2">算力平台扣费系统：从设计到开发全过程</div></div><div class="info-2"><div class="info-item-1">算力平台扣费系统：从设计到开发全过程 本文记录了一个完整的分布式扣费系统的设计思路、技术选型、架构设计、核心实现以及踩坑经验，适合有一定Java开发经验的读者阅读。  目录 一、项目背景 二、需求分析 三、技术选型 四、架构设计 五、数据库设计 六、核心功能实现 七、关键技术点 八、踩坑与优化 九、测试与验证 十、总结与思考   一、项目背景1.1 业务场景这是一个算力租赁平台的扣费系统，主要业务场景包括：  包月预付费：用户购买包月算力，一次性扣除整月费用 按小时后付费：用户按小时使用算力，每小时自动续扣 退款处理：支持全额退款、部分退款、按订单退款、按扣费单退款 余额预警：提前通知用户余额不足，避免服务突然中断  1.2 核心挑战 资金安全：不能重复扣费，不能多退少退 高并发：支持大量用户同时扣费 幂等性：网络重试、系统故障恢复时不能重复扣费 系统解耦：与订单系统、资源系统解耦，通过消息队列异步通信 可追溯性：每笔扣费都有完整的流水记录，支持对账   二、需求分析2.1 功能需求2.1.1 扣费功能   功能 说明 优先级    包月扣费 一次性扣除整月费用 P0   按小时...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Goppop</div><div class="author-info-description">周期越大，结构越清晰</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Goppop"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%8E%A5%E6%96%87%E6%A1%A3"><span class="toc-number">1.</span> <span class="toc-text">扣费系统对接文档</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"><span class="toc-number">1.2.</span> <span class="toc-text">2. 快速开始</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 添加依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%B3%A8%E5%85%A5%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 注入接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E6%89%A7%E8%A1%8C%E6%89%A3%E8%B4%B9"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 执行扣费</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.</span> <span class="toc-text">3. 核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%89%A3%E8%B4%B9%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 扣费类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E4%B8%BB%E8%AE%B0%E5%BD%95%E4%B8%8E%E6%98%8E%E7%BB%86%E8%AE%B0%E5%BD%95"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 主记录与明细记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%89%A3%E8%B4%B9%E7%8A%B6%E6%80%81"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 扣费状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-API%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.4.</span> <span class="toc-text">4. API接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E6%89%A7%E8%A1%8C%E6%89%A3%E8%B4%B9"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 执行扣费</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E6%8C%89%E8%AE%A2%E5%8D%95%E5%8F%B7%E9%80%80%E6%AC%BE"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 按订单号退款</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E6%8C%89%E6%89%A3%E8%B4%B9%E5%8D%95%E5%8F%B7%E9%80%80%E6%AC%BE"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 按扣费单号退款</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E9%83%A8%E5%88%86%E9%80%80%E6%AC%BE"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.4 部分退款</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E6%8C%89%E8%AE%A2%E5%8D%95%E5%8F%B7%E5%81%9C%E6%AD%A2%E5%91%A8%E6%9C%9F%E6%89%A3%E8%B4%B9"><span class="toc-number">1.4.5.</span> <span class="toc-text">4.5 按订单号停止周期扣费</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E6%8C%89%E6%89%A3%E8%B4%B9%E5%8D%95%E5%8F%B7%E5%81%9C%E6%AD%A2%E5%91%A8%E6%9C%9F%E6%89%A3%E8%B4%B9"><span class="toc-number">1.4.6.</span> <span class="toc-text">4.6 按扣费单号停止周期扣费</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%85%B8%E5%9E%8B%E5%9C%BA%E6%99%AF"><span class="toc-number">1.5.</span> <span class="toc-text">5. 典型场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%9C%BA%E6%99%AF1%EF%BC%9A%E7%94%A8%E6%88%B7%E8%B4%AD%E4%B9%B0%E5%8C%85%E6%9C%88%E7%AE%97%E5%8A%9B"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 场景1：用户购买包月算力</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%9C%BA%E6%99%AF2%EF%BC%9A%E7%94%A8%E6%88%B7%E8%B4%AD%E4%B9%B0%E6%8C%89%E5%B0%8F%E6%97%B6%E7%AE%97%E5%8A%9B"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 场景2：用户购买按小时算力</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E5%9C%BA%E6%99%AF3%EF%BC%9A%E7%94%A8%E6%88%B7%E7%94%B3%E8%AF%B7%E9%80%80%E6%AC%BE"><span class="toc-number">1.5.3.</span> <span class="toc-text">5.3 场景3：用户申请退款</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E5%9C%BA%E6%99%AF4%EF%BC%9A%E7%94%A8%E6%88%B7%E9%87%8A%E6%94%BE%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.5.4.</span> <span class="toc-text">5.4 场景4：用户释放实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E5%9C%BA%E6%99%AF5%EF%BC%9A%E8%AE%A2%E5%8D%95%E5%8D%87%E9%99%8D%E9%85%8D"><span class="toc-number">1.5.5.</span> <span class="toc-text">5.5 场景5：订单升降配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-%E5%9C%BA%E6%99%AF6%EF%BC%9A%E5%A4%84%E7%90%86%E4%BD%99%E9%A2%9D%E9%A2%84%E8%AD%A6"><span class="toc-number">1.5.6.</span> <span class="toc-text">5.6 场景6：处理余额预警</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81"><span class="toc-number">1.6.</span> <span class="toc-text">6. 消息推送</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E6%89%A3%E8%B4%B9%E7%BB%93%E6%9E%9C%E6%B6%88%E6%81%AF"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 扣费结果消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E4%BD%99%E9%A2%9D%E9%A2%84%E8%AD%A6%E6%B6%88%E6%81%AF"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 余额预警消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E4%BD%99%E9%A2%9D%E4%B8%8D%E8%B6%B3%E6%B6%88%E6%81%AF"><span class="toc-number">1.6.3.</span> <span class="toc-text">6.3 余额不足消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E9%80%80%E6%AC%BE%E7%BB%93%E6%9E%9C%E6%B6%88%E6%81%AF"><span class="toc-number">1.6.4.</span> <span class="toc-text">6.4 退款结果消息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E4%BD%99%E9%A2%9D%E9%A2%84%E8%AD%A6%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.7.</span> <span class="toc-text">7. 余额预警系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E9%A2%84%E8%AD%A6%E6%9C%BA%E5%88%B6%E8%AF%B4%E6%98%8E"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 预警机制说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E9%A2%84%E8%AD%A6%E8%A7%A6%E5%8F%91%E6%96%B9%E5%BC%8F"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 预警触发方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E9%A2%84%E8%AD%A6%E5%8E%BB%E9%87%8D%E6%9C%BA%E5%88%B6"><span class="toc-number">1.7.3.</span> <span class="toc-text">7.3 预警去重机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-%E8%AE%A2%E5%8D%95%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8"><span class="toc-number">1.7.4.</span> <span class="toc-text">7.4 订单系统如何使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">1.7.4.1.</span> <span class="toc-text">使用流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC1%E6%AD%A5%EF%BC%9A%E5%88%9B%E5%BB%BARabbitMQ%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">1.7.4.2.</span> <span class="toc-text">第1步：创建RabbitMQ消费者</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC2%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AERabbitMQ%E9%98%9F%E5%88%97"><span class="toc-number">1.7.4.3.</span> <span class="toc-text">第2步：配置RabbitMQ队列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC3%E6%AD%A5%EF%BC%9A%E5%A4%84%E7%90%86%E9%A2%84%E8%AD%A6%E5%90%8E%E7%9A%84%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91"><span class="toc-number">1.7.4.4.</span> <span class="toc-text">第3步：处理预警后的业务逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC4%E6%AD%A5%EF%BC%9A%E5%89%8D%E7%AB%AF%E5%B1%95%E7%A4%BA%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-number">1.7.4.5.</span> <span class="toc-text">第4步：前端展示（可选）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-%E9%A2%84%E8%AD%A6%E6%B6%88%E6%81%AF%E5%AD%97%E6%AE%B5%E8%AF%B4%E6%98%8E"><span class="toc-number">1.7.5.</span> <span class="toc-text">7.5 预警消息字段说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-%E9%A2%84%E8%AD%A6%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE"><span class="toc-number">1.7.6.</span> <span class="toc-text">7.6 预警系统配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-7-%E9%87%8D%E8%A6%81%E8%AF%B4%E6%98%8E"><span class="toc-number">1.7.7.</span> <span class="toc-text">7.7 重要说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-8-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.7.8.</span> <span class="toc-text">7.8 最佳实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-9-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">1.7.9.</span> <span class="toc-text">7.9 常见问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E9%87%8D%E8%A6%81%E8%AF%B4%E6%98%8E"><span class="toc-number">1.8.</span> <span class="toc-text">8. 重要说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E5%B9%82%E7%AD%89%E6%80%A7%E4%BF%9D%E8%AF%81"><span class="toc-number">1.8.1.</span> <span class="toc-text">8.1 幂等性保证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E5%91%A8%E6%9C%9F%E6%89%A3%E8%B4%B9%E8%AF%B4%E6%98%8E"><span class="toc-number">1.8.2.</span> <span class="toc-text">8.2 周期扣费说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E9%87%91%E9%A2%9D%E8%AF%B4%E6%98%8E"><span class="toc-number">1.8.3.</span> <span class="toc-text">8.3 金额说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.8.4.</span> <span class="toc-text">8.4 错误处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E9%99%84%E5%BD%95"><span class="toc-number">1.9.</span> <span class="toc-text">9. 附录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-number">1.9.1.</span> <span class="toc-text">9.1 数据库表结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="toc-number">1.9.2.</span> <span class="toc-text">9.2 测试用例</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/Java%20%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88JUC%EF%BC%89%E9%AB%98%E7%BA%A7%E7%BB%84%E4%BB%B6%E4%B8%8E%E5%8E%9F%E7%90%86%EF%BC%9A%E4%BB%8E%20AQS%20%E5%88%B0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%20(1)/" title="Java 并发编程（JUC）高级组件与原理：从 AQS 到并发容器">Java 并发编程（JUC）高级组件与原理：从 AQS 到并发容器</a><time datetime="2025-12-16T16:00:00.000Z" title="发表于 2025-12-17 00:00:00">2025-12-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/Spring%20Boot%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9AAOP%E3%80%81IOC%20%E4%B8%8E%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE/" title="Spring Boot 核心原理与源码解析：AOP、IOC 与自动配置">Spring Boot 核心原理与源码解析：AOP、IOC 与自动配置</a><time datetime="2025-12-16T16:00:00.000Z" title="发表于 2025-12-17 00:00:00">2025-12-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/code-learning/programming-basics/jvm/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/JVM-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/" title="JVM-垃圾回收机制详解">JVM-垃圾回收机制详解</a><time datetime="2025-12-11T16:00:00.000Z" title="发表于 2025-12-12 00:00:00">2025-12-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/code-learning/programming-basics/jvm/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/JVM-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E8%AF%A6%E8%A7%A3/" title="JVM-内存模型详解">JVM-内存模型详解</a><time datetime="2025-12-11T16:00:00.000Z" title="发表于 2025-12-12 00:00:00">2025-12-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/code-learning/programming-basics/jvm/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/JVM-%E5%85%A5%E9%97%A8%E6%A6%82%E8%A7%88/" title="JVM-入门概览">JVM-入门概览</a><time datetime="2025-12-11T16:00:00.000Z" title="发表于 2025-12-12 00:00:00">2025-12-12</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Goppop</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.1.1</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.3-b1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3-b1"></script><script src="/js/main.js?v=5.5.3-b1"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>