<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>算力平台扣费系统设计方案 | Goppop的博客</title><meta name="author" content="Goppop"><meta name="copyright" content="Goppop"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="文章描述">
<meta property="og:type" content="article">
<meta property="og:title" content="算力平台扣费系统设计方案">
<meta property="og:url" content="https://goppop.github.io/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/index.html">
<meta property="og:site_name" content="Goppop的博客">
<meta property="og:description" content="文章描述">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://goppop.github.io/img/butterfly-icon.png">
<meta property="article:published_time" content="2025-12-09T16:00:00.000Z">
<meta property="article:modified_time" content="2025-12-10T06:08:15.539Z">
<meta property="article:author" content="Goppop">
<meta property="article:tag" content="系统开发">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://goppop.github.io/img/butterfly-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "算力平台扣费系统设计方案",
  "url": "https://goppop.github.io/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/",
  "image": "https://goppop.github.io/img/butterfly-icon.png",
  "datePublished": "2025-12-09T16:00:00.000Z",
  "dateModified": "2025-12-10T06:08:15.539Z",
  "author": [
    {
      "@type": "Person",
      "name": "Goppop",
      "url": "https://goppop.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://goppop.github.io/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.3-b1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '算力平台扣费系统设计方案',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.1.1"></head><body><div id="web_bg" style="background-image: url(https://images.pexels.com/photos/1200252/pexels-photo-1200252.jpeg);"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.pixabay.com/photo/2021/03/29/08/22/peach-flower-6133330_1280.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Goppop的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">算力平台扣费系统设计方案</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">算力平台扣费系统设计方案</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-12-09T16:00:00.000Z" title="发表于 2025-12-10 00:00:00">2025-12-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-12-10T06:08:15.539Z" title="更新于 2025-12-10 14:08:15">2025-12-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/code-learning/">code-learning</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="算力平台扣费系统设计方案"><a href="#算力平台扣费系统设计方案" class="headerlink" title="算力平台扣费系统设计方案"></a>算力平台扣费系统设计方案</h1><h2 id="一、设计目标"><a href="#一、设计目标" class="headerlink" title="一、设计目标"></a>一、设计目标</h2><h3 id="1-1-核心需求"><a href="#1-1-核心需求" class="headerlink" title="1.1 核心需求"></a>1.1 核心需求</h3><ul>
<li><strong>包月（预付费）</strong>：一次性扣除整月费用</li>
<li><strong>按小时计费（后付费）</strong>：先扣首小时费用，后续每小时自动续扣</li>
<li><strong>资金安全</strong>：不重复扣、不多退</li>
<li><strong>操作幂等</strong>：同一订单多次调用只生效一次</li>
<li><strong>高可用 &amp; 可对账</strong>：支持故障恢复和数据核对</li>
<li><strong>系统解耦</strong>：与订单&#x2F;资源系统解耦，通过消息队列异步通信</li>
</ul>
<h3 id="1-2-设计原则"><a href="#1-2-设计原则" class="headerlink" title="1.2 设计原则"></a>1.2 设计原则</h3><ol>
<li><strong>最终一致性</strong>：允许短暂的数据不一致，通过补偿机制保证最终一致</li>
<li><strong>幂等优先</strong>：所有扣费操作必须支持幂等</li>
<li><strong>可追溯性</strong>：每笔扣费都有完整的流水记录</li>
<li><strong>故障隔离</strong>：扣费系统故障不影响订单和资源系统</li>
</ol>
<hr>
<h2 id="二、核心架构设计"><a href="#二、核心架构设计" class="headerlink" title="二、核心架构设计"></a>二、核心架构设计</h2><h3 id="2-1-系统分层"><a href="#2-1-系统分层" class="headerlink" title="2.1 系统分层"></a>2.1 系统分层</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│                    订单系统                              │</span><br><span class="line">│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │</span><br><span class="line">│  │  订单创建    │  │  订单支付    │  │  订单完成    │ │</span><br><span class="line">│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘ │</span><br><span class="line">│         │                 │                  │         │</span><br><span class="line">│         └─────────────────┼──────────────────┘         │</span><br><span class="line">│                           │                            │</span><br><span class="line">│                   发送扣费消息                          │</span><br><span class="line">└───────────────────────────┼────────────────────────────┘</span><br><span class="line">                            │</span><br><span class="line">                            ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│                  扣费系统（核心）                        │</span><br><span class="line">│  ┌──────────────────────────────────────────────────┐  │</span><br><span class="line">│  │  扣费服务层（DeductionService）                   │  │</span><br><span class="line">│  │  - 包月扣费（一次性）                            │  │</span><br><span class="line">│  │  - 按小时扣费（周期性）                          │  │</span><br><span class="line">│  │  - 退款处理                                      │  │</span><br><span class="line">│  └──────────────────────────────────────────────────┘  │</span><br><span class="line">│  ┌──────────────────────────────────────────────────┐  │</span><br><span class="line">│  │  账户服务层（AccountService）                    │  │</span><br><span class="line">│  │  - 余额扣减（乐观锁）                            │  │</span><br><span class="line">│  │  - 余额增加（退款）                              │  │</span><br><span class="line">│  │  - 流水记录                                      │  │</span><br><span class="line">│  └──────────────────────────────────────────────────┘  │</span><br><span class="line">│  ┌──────────────────────────────────────────────────┐  │</span><br><span class="line">│  │  定时任务层（ScheduledTask）                     │  │</span><br><span class="line">│  │  - 按小时续扣任务                                │  │</span><br><span class="line">│  │  - 余额不足处理                                  │  │</span><br><span class="line">│  │  - 对账任务                                      │  │</span><br><span class="line">│  └──────────────────────────────────────────────────┘  │</span><br><span class="line">└───────────────────────────┬────────────────────────────┘</span><br><span class="line">                            │</span><br><span class="line">                            ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│                  资源系统                                │</span><br><span class="line">│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │</span><br><span class="line">│  │  资源创建    │  │  资源释放    │  │  资源监控    │ │</span><br><span class="line">│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘ │</span><br><span class="line">│         │                 │                  │         │</span><br><span class="line">│         └─────────────────┼──────────────────┘         │</span><br><span class="line">│                           │                            │</span><br><span class="line">│                   接收扣费结果                          │</span><br><span class="line">└─────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="2-2-数据模型设计"><a href="#2-2-数据模型设计" class="headerlink" title="2.2 数据模型设计"></a>2.2 数据模型设计</h3><h4 id="2-2-1-扣费记录表（deduction-record）"><a href="#2-2-1-扣费记录表（deduction-record）" class="headerlink" title="2.2.1 扣费记录表（deduction_record）"></a>2.2.1 扣费记录表（deduction_record）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> `tgkw_deduction_record` (</span><br><span class="line">  `id` <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">  `deduction_no` <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;扣费单号，唯一标识&#x27;</span>,</span><br><span class="line">  `order_no` <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;关联订单号&#x27;</span>,</span><br><span class="line">  `instance_id` <span class="type">VARCHAR</span>(<span class="number">64</span>) COMMENT <span class="string">&#x27;关联实例ID&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">-- 扣费信息</span></span><br><span class="line">  `deduction_type` <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;扣费类型：MONTHLY_PREPAID-包月预付费，HOURLY_POSTPAID-按小时后付费&#x27;</span>,</span><br><span class="line">  `billing_type` <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;计费方式：MONTHLY-包月，HOURLY-按小时&#x27;</span>,</span><br><span class="line">  `amount` <span class="type">DECIMAL</span>(<span class="number">18</span>,<span class="number">4</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;扣费金额&#x27;</span>,</span><br><span class="line">  `unit_price` <span class="type">DECIMAL</span>(<span class="number">18</span>,<span class="number">4</span>) COMMENT <span class="string">&#x27;单价（每小时或每月）&#x27;</span>,</span><br><span class="line">  `duration_hours` <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) COMMENT <span class="string">&#x27;时长（小时）&#x27;</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">-- 周期扣费相关（仅按小时计费）</span></span><br><span class="line">  `is_periodic` TINYINT(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;是否周期扣费：0-否，1-是&#x27;</span>,</span><br><span class="line">  `period_hours` <span class="type">INT</span> COMMENT <span class="string">&#x27;扣费周期（小时），默认1小时&#x27;</span>,</span><br><span class="line">  `next_deduction_time` DATETIME COMMENT <span class="string">&#x27;下次扣费时间&#x27;</span>,</span><br><span class="line">  `total_periods` <span class="type">INT</span> COMMENT <span class="string">&#x27;总扣费次数（-1表示无限）&#x27;</span>,</span><br><span class="line">  `current_period` <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;当前已扣费次数&#x27;</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">-- 状态信息</span></span><br><span class="line">  `status` <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;状态：PENDING-待扣费，SUCCESS-扣费成功，FAILED-扣费失败，STOPPED-已停止，REFUNDED-已退款&#x27;</span>,</span><br><span class="line">  `deduction_time` DATETIME COMMENT <span class="string">&#x27;扣费时间&#x27;</span>,</span><br><span class="line">  `fail_reason` <span class="type">VARCHAR</span>(<span class="number">500</span>) COMMENT <span class="string">&#x27;失败原因&#x27;</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">-- 幂等性保证</span></span><br><span class="line">  `idempotent_key` <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;幂等键，格式：orderNo_deductionType_period&#x27;</span>,</span><br><span class="line">  `retry_count` <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;重试次数&#x27;</span>,</span><br><span class="line">  `max_retry` <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">3</span> COMMENT <span class="string">&#x27;最大重试次数&#x27;</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">-- 关联信息</span></span><br><span class="line">  `account_transaction_no` <span class="type">VARCHAR</span>(<span class="number">64</span>) COMMENT <span class="string">&#x27;关联账户流水号&#x27;</span>,</span><br><span class="line">  `billing_transaction_id` <span class="type">BIGINT</span> COMMENT <span class="string">&#x27;关联计费流水ID&#x27;</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">-- 时间字段</span></span><br><span class="line">  `create_time` DATETIME <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `update_time` DATETIME <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `tenant_id` <span class="type">BIGINT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">  `deleted` TINYINT(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_deduction_no` (`deduction_no`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_idempotent_key` (`idempotent_key`),</span><br><span class="line">  KEY `idx_order_no` (`order_no`),</span><br><span class="line">  KEY `idx_user_id` (`user_id`),</span><br><span class="line">  KEY `idx_instance_id` (`instance_id`),</span><br><span class="line">  KEY `idx_status` (`status`),</span><br><span class="line">  KEY `idx_next_deduction_time` (`next_deduction_time`, `status`),</span><br><span class="line">  KEY `idx_create_time` (`create_time`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;扣费记录表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>关键设计点：</strong></p>
<ol>
<li><strong>idempotent_key</strong>：保证幂等性，格式：<code>{orderNo}_{deductionType}_{period}</code>，例如：<code>ORD001_MONTHLY_PREPAID_0</code>、<code>ORD002_HOURLY_POSTPAID_1</code></li>
<li><strong>is_periodic + next_deduction_time</strong>：支持周期扣费</li>
<li><strong>status</strong>：完整的状态流转，支持失败重试和退款</li>
</ol>
<h4 id="2-2-2-账户流水表（account-transaction）"><a href="#2-2-2-账户流水表（account-transaction）" class="headerlink" title="2.2.2 账户流水表（account_transaction）"></a>2.2.2 账户流水表（account_transaction）</h4><p>复用现有的账户流水表设计方案，记录每笔资金变动。</p>
<hr>
<h2 id="三、核心流程设计"><a href="#三、核心流程设计" class="headerlink" title="三、核心流程设计"></a>三、核心流程设计</h2><h3 id="3-1-包月扣费流程（预付费）"><a href="#3-1-包月扣费流程（预付费）" class="headerlink" title="3.1 包月扣费流程（预付费）"></a>3.1 包月扣费流程（预付费）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">订单系统                          扣费系统                          账户系统</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │── 1.订单支付成功 ──────────────&gt;│                                │</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 2.创建扣费记录 ──────────────&gt;│</span><br><span class="line">   │                                │   (status=PENDING)              │</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 3.扣减余额 ──────────────────&gt;│</span><br><span class="line">   │                                │   (乐观锁保证并发安全)          │</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │&lt;── 4.扣费结果 ──────────────────│</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 5.记录账户流水 ───────────────&gt;│</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 6.更新扣费记录 ───────────────&gt;│</span><br><span class="line">   │                                │   (status=SUCCESS)              │</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │&lt;── 7.发送扣费成功消息 ──────────│                                │</span><br><span class="line">   │                                │                                │</span><br></pre></td></tr></table></figure>

<p><strong>实现要点：</strong></p>
<ol>
<li><strong>幂等性</strong>：使用 <code>idempotent_key = orderNo + &quot;_MONTHLY_PREPAID_0&quot;</code> 保证同一订单只扣一次</li>
<li><strong>事务性</strong>：扣费记录创建、余额扣减、流水记录在同一事务中</li>
<li><strong>失败处理</strong>：扣费失败记录失败原因，支持手动重试</li>
</ol>
<h3 id="3-2-按小时扣费流程（后付费）"><a href="#3-2-按小时扣费流程（后付费）" class="headerlink" title="3.2 按小时扣费流程（后付费）"></a>3.2 按小时扣费流程（后付费）</h3><h4 id="3-2-1-首小时扣费"><a href="#3-2-1-首小时扣费" class="headerlink" title="3.2.1 首小时扣费"></a>3.2.1 首小时扣费</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">订单系统                          扣费系统                          账户系统</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │── 1.订单支付成功 ──────────────&gt;│                                │</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 2.创建扣费记录 ──────────────&gt;│</span><br><span class="line">   │                                │   (is_periodic=1,              │</span><br><span class="line">   │                                │    next_deduction_time=+1h)    │</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 3.扣减首小时费用 ────────────&gt;│</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │&lt;── 4.扣费结果 ──────────────────│</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 5.记录账户流水 ───────────────&gt;│</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 6.更新扣费记录 ───────────────&gt;│</span><br><span class="line">   │                                │   (status=SUCCESS,              │</span><br><span class="line">   │                                │    current_period=1)            │</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │&lt;── 7.发送扣费成功消息 ──────────│                                │</span><br><span class="line">   │                                │                                │</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-周期续扣（定时任务）"><a href="#3-2-2-周期续扣（定时任务）" class="headerlink" title="3.2.2 周期续扣（定时任务）"></a>3.2.2 周期续扣（定时任务）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">定时任务                          扣费系统                          账户系统</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │── 1.扫描待续扣记录 ────────────&gt;│                                │</span><br><span class="line">   │   (next_deduction_time &lt;= now) │                                │</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 2.检查实例状态 ───────────────&gt;│</span><br><span class="line">   │                                │   (是否仍在运行)                │</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 3.计算本次扣费金额 ──────────&gt;│</span><br><span class="line">   │                                │   (1小时费用)                   │</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 4.扣减余额 ──────────────────&gt;│</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │&lt;── 5.扣费结果 ──────────────────│</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │   ┌────────────────────────────┼────────────────────────────┐  │</span><br><span class="line">   │   │ 成功                        │ 失败（余额不足）            │  │</span><br><span class="line">   │   │                            │                            │  │</span><br><span class="line">   │   │── 6a.记录账户流水           │── 6b.记录失败原因           │  │</span><br><span class="line">   │   │── 7a.更新扣费记录           │── 7b.更新扣费记录           │  │</span><br><span class="line">   │   │   (current_period++,        │   (status=FAILED,          │  │</span><br><span class="line">   │   │    next_deduction_time+=1h) │    fail_reason=余额不足)    │  │</span><br><span class="line">   │   │                            │                            │  │</span><br><span class="line">   │   │── 8a.发送续扣成功消息       │── 8b.发送余额不足通知       │  │</span><br><span class="line">   │   │                            │── 9b.通知资源系统停止实例   │  │</span><br><span class="line">   │   └────────────────────────────┴────────────────────────────┘  │</span><br></pre></td></tr></table></figure>

<p><strong>实现要点：</strong></p>
<ol>
<li><strong>定时任务</strong>：使用 XXL-Job 或 Quartz，每分钟扫描一次待续扣记录</li>
<li><strong>幂等性</strong>：每次续扣使用 <code>idempotent_key = orderNo + &quot;_HOURLY_POSTPAID_&quot; + period</code> 保证不重复</li>
<li><strong>余额不足处理</strong>：<ul>
<li>记录失败原因</li>
<li>发送余额不足通知给用户</li>
<li>通知资源系统停止实例（可选）</li>
<li>支持用户充值后手动重试</li>
</ul>
</li>
</ol>
<h3 id="3-3-退款流程"><a href="#3-3-退款流程" class="headerlink" title="3.3 退款流程"></a>3.3 退款流程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">订单/资源系统                    扣费系统                          账户系统</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │── 1.退款请求 ──────────────────&gt;│                                │</span><br><span class="line">   │   (orderNo, reason)            │                                │</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 2.查询扣费记录 ───────────────&gt;│</span><br><span class="line">   │                                │   (按订单号查询)                │</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 3.校验退款条件 ───────────────&gt;│</span><br><span class="line">   │                                │   (是否已扣费、是否已退款)      │</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 4.创建退款记录 ───────────────&gt;│</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 5.增加余额 ──────────────────&gt;│</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 6.记录账户流水 ───────────────&gt;│</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 7.更新扣费记录 ───────────────&gt;│</span><br><span class="line">   │                                │   (status=REFUNDED)             │</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │                                │── 8.停止周期扣费 ───────────────&gt;│</span><br><span class="line">   │                                │   (如果是周期扣费)              │</span><br><span class="line">   │                                │                                │</span><br><span class="line">   │&lt;── 9.发送退款成功消息 ──────────│                                │</span><br><span class="line">   │                                │                                │</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四、幂等性保证机制"><a href="#四、幂等性保证机制" class="headerlink" title="四、幂等性保证机制"></a>四、幂等性保证机制</h2><h3 id="4-1-幂等键设计"><a href="#4-1-幂等键设计" class="headerlink" title="4.1 幂等键设计"></a>4.1 幂等键设计</h3><p><strong>格式：</strong> <code>{orderNo}_{deductionType}_{period}</code></p>
<p><strong>示例：</strong></p>
<ul>
<li>包月扣费：<code>ORD001_MONTHLY_PREPAID_0</code></li>
<li>按小时首扣：<code>ORD002_HOURLY_POSTPAID_0</code></li>
<li>按小时第2次：<code>ORD002_HOURLY_POSTPAID_1</code></li>
<li>按小时第3次：<code>ORD002_HOURLY_POSTPAID_2</code></li>
</ul>
<h3 id="4-2-幂等性实现"><a href="#4-2-幂等性实现" class="headerlink" title="4.2 幂等性实现"></a>4.2 幂等性实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> DeductionResult <span class="title function_">deduct</span><span class="params">(DeductionRequest request)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 生成幂等键</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idempotentKey</span> <span class="operator">=</span> generateIdempotentKey(</span><br><span class="line">        request.getOrderNo(), </span><br><span class="line">        request.getDeductionType(), </span><br><span class="line">        request.getPeriod()</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 查询是否已存在</span></span><br><span class="line">    <span class="type">DeductionRecordDO</span> <span class="variable">existing</span> <span class="operator">=</span> deductionRecordMapper.selectByIdempotentKey(idempotentKey);</span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 已存在，直接返回结果</span></span><br><span class="line">        <span class="keyword">if</span> (DeductionStatusEnum.SUCCESS.equals(existing.getStatus())) &#123;</span><br><span class="line">            <span class="keyword">return</span> DeductionResult.success(existing);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果是失败状态，可以重试（在重试次数限制内）</span></span><br><span class="line">        <span class="keyword">if</span> (DeductionStatusEnum.FAILED.equals(existing.getStatus()) </span><br><span class="line">            &amp;&amp; existing.getRetryCount() &lt; existing.getMaxRetry()) &#123;</span><br><span class="line">            <span class="comment">// 继续执行扣费逻辑</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> DeductionResult.fail(<span class="string">&quot;扣费已存在且不可重试&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 创建扣费记录（使用唯一索引保证并发安全）</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">DeductionRecordDO</span> <span class="variable">record</span> <span class="operator">=</span> createDeductionRecord(request, idempotentKey);</span><br><span class="line">        <span class="comment">// 4. 执行扣费</span></span><br><span class="line">        <span class="keyword">return</span> executeDeduction(record);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DuplicateKeyException e) &#123;</span><br><span class="line">        <span class="comment">// 并发情况下，另一个线程已创建，重新查询</span></span><br><span class="line">        existing = deductionRecordMapper.selectByIdempotentKey(idempotentKey);</span><br><span class="line">        <span class="keyword">return</span> DeductionResult.success(existing);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-数据库唯一索引"><a href="#4-3-数据库唯一索引" class="headerlink" title="4.3 数据库唯一索引"></a>4.3 数据库唯一索引</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UNIQUE</span> KEY `uk_idempotent_key` (`idempotent_key`)</span><br></pre></td></tr></table></figure>

<p><strong>作用：</strong></p>
<ul>
<li>数据库层面保证幂等键唯一</li>
<li>并发情况下，第二个插入会失败，捕获异常后查询已存在的记录</li>
</ul>
<hr>
<h2 id="五、定时任务设计"><a href="#五、定时任务设计" class="headerlink" title="五、定时任务设计"></a>五、定时任务设计</h2><h3 id="5-1-按小时续扣任务"><a href="#5-1-按小时续扣任务" class="headerlink" title="5.1 按小时续扣任务"></a>5.1 按小时续扣任务</h3><p><strong>任务名称：</strong> <code>HourlyDeductionJob</code></p>
<p><strong>执行频率：</strong> 每分钟执行一次</p>
<p><strong>执行逻辑：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@XxlJob(&quot;hourlyDeductionJob&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hourlyDeduction</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 查询待续扣记录</span></span><br><span class="line">    <span class="comment">// next_deduction_time &lt;= now AND status = SUCCESS AND is_periodic = 1</span></span><br><span class="line">    List&lt;DeductionRecordDO&gt; records = deductionRecordMapper.selectPendingPeriodicDeductions(</span><br><span class="line">        LocalDateTime.now()</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (DeductionRecordDO record : records) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2. 检查实例是否仍在运行（调用资源系统API）</span></span><br><span class="line">            <span class="keyword">if</span> (!isInstanceRunning(record.getInstanceId())) &#123;</span><br><span class="line">                <span class="comment">// 实例已停止，停止周期扣费</span></span><br><span class="line">                stopPeriodicDeduction(record);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 计算本次扣费金额（1小时费用）</span></span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">amount</span> <span class="operator">=</span> calculateHourlyAmount(record);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4. 执行扣费</span></span><br><span class="line">            <span class="type">DeductionRequest</span> <span class="variable">request</span> <span class="operator">=</span> buildDeductionRequest(record, amount);</span><br><span class="line">            <span class="type">DeductionResult</span> <span class="variable">result</span> <span class="operator">=</span> deductionService.deduct(request);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (result.isSuccess()) &#123;</span><br><span class="line">                <span class="comment">// 5. 更新下次扣费时间</span></span><br><span class="line">                updateNextDeductionTime(record, <span class="number">1</span>); <span class="comment">// +1小时</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 扣费失败，记录失败原因</span></span><br><span class="line">                handleDeductionFailure(record, result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;续扣失败，扣费记录ID: &#123;&#125;&quot;</span>, record.getId(), e);</span><br><span class="line">            <span class="comment">// 记录失败，但不中断其他记录的处理</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-余额不足处理"><a href="#5-2-余额不足处理" class="headerlink" title="5.2 余额不足处理"></a>5.2 余额不足处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleDeductionFailure</span><span class="params">(DeductionRecordDO record, DeductionResult result)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 更新扣费记录状态</span></span><br><span class="line">    record.setStatus(DeductionStatusEnum.FAILED);</span><br><span class="line">    record.setFailReason(result.getFailReason());</span><br><span class="line">    deductionRecordMapper.updateById(record);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 发送余额不足通知（MQ）</span></span><br><span class="line">    <span class="type">BalanceInsufficientMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BalanceInsufficientMessage</span>();</span><br><span class="line">    message.setUserId(record.getUserId());</span><br><span class="line">    message.setOrderNo(record.getOrderNo());</span><br><span class="line">    message.setInstanceId(record.getInstanceId());</span><br><span class="line">    message.setRequiredAmount(result.getRequiredAmount());</span><br><span class="line">    messageProducer.sendBalanceInsufficient(message);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 通知资源系统（可选：自动停止实例）</span></span><br><span class="line">    <span class="keyword">if</span> (config.isAutoStopOnInsufficientBalance()) &#123;</span><br><span class="line">        resourceService.stopInstance(record.getInstanceId(), <span class="string">&quot;余额不足&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-对账任务"><a href="#5-3-对账任务" class="headerlink" title="5.3 对账任务"></a>5.3 对账任务</h3><p><strong>任务名称：</strong> <code>DeductionReconciliationJob</code></p>
<p><strong>执行频率：</strong> 每天凌晨2点执行</p>
<p><strong>执行逻辑：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@XxlJob(&quot;deductionReconciliationJob&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reconciliation</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">LocalDate</span> <span class="variable">yesterday</span> <span class="operator">=</span> LocalDate.now().minusDays(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 查询昨天的所有扣费记录</span></span><br><span class="line">    List&lt;DeductionRecordDO&gt; deductions = deductionRecordMapper.selectByDate(yesterday);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 查询昨天的所有账户流水</span></span><br><span class="line">    List&lt;AccountTransactionDO&gt; transactions = accountTransactionService.selectByDate(yesterday);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 对账：扣费记录金额总和 = 账户流水扣款金额总和</span></span><br><span class="line">    <span class="type">BigDecimal</span> <span class="variable">deductionTotal</span> <span class="operator">=</span> deductions.stream()</span><br><span class="line">        .filter(d -&gt; DeductionStatusEnum.SUCCESS.equals(d.getStatus()))</span><br><span class="line">        .map(DeductionRecordDO::getAmount)</span><br><span class="line">        .reduce(BigDecimal.ZERO, BigDecimal::add);</span><br><span class="line">    </span><br><span class="line">    <span class="type">BigDecimal</span> <span class="variable">transactionTotal</span> <span class="operator">=</span> transactions.stream()</span><br><span class="line">        .filter(t -&gt; TransactionTypeEnum.CONSUME.equals(t.getTransactionType()))</span><br><span class="line">        .map(AccountTransactionDO::getAmount)</span><br><span class="line">        .map(BigDecimal::abs) <span class="comment">// 流水表中扣款是负数，取绝对值</span></span><br><span class="line">        .reduce(BigDecimal.ZERO, BigDecimal::add);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 比对结果</span></span><br><span class="line">    <span class="keyword">if</span> (deductionTotal.compareTo(transactionTotal) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 对账不平，记录异常</span></span><br><span class="line">        log.error(<span class="string">&quot;对账不平！日期: &#123;&#125;, 扣费总额: &#123;&#125;, 流水总额: &#123;&#125;&quot;</span>, </span><br><span class="line">            yesterday, deductionTotal, transactionTotal);</span><br><span class="line">        <span class="comment">// 发送告警通知</span></span><br><span class="line">        sendReconciliationAlert(yesterday, deductionTotal, transactionTotal);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="六、与订单-资源系统解耦"><a href="#六、与订单-资源系统解耦" class="headerlink" title="六、与订单&#x2F;资源系统解耦"></a>六、与订单&#x2F;资源系统解耦</h2><h3 id="6-1-消息队列设计"><a href="#6-1-消息队列设计" class="headerlink" title="6.1 消息队列设计"></a>6.1 消息队列设计</h3><h4 id="6-1-1-扣费请求消息（订单系统-→-扣费系统）"><a href="#6-1-1-扣费请求消息（订单系统-→-扣费系统）" class="headerlink" title="6.1.1 扣费请求消息（订单系统 → 扣费系统）"></a>6.1.1 扣费请求消息（订单系统 → 扣费系统）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeductionRequestMessage</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String orderNo;           <span class="comment">// 订单号</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;               <span class="comment">// 用户ID</span></span><br><span class="line">    <span class="keyword">private</span> String instanceId;         <span class="comment">// 实例ID（可选）</span></span><br><span class="line">    <span class="keyword">private</span> String deductionType;      <span class="comment">// 扣费类型：MONTHLY_PREPAID, HOURLY_POSTPAID</span></span><br><span class="line">    <span class="keyword">private</span> String billingType;        <span class="comment">// 计费方式：MONTHLY, HOURLY</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal amount;        <span class="comment">// 扣费金额</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal unitPrice;      <span class="comment">// 单价</span></span><br><span class="line">    <span class="keyword">private</span> Integer durationHours;      <span class="comment">// 时长（小时）</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; extra; <span class="comment">// 扩展信息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>队列配置：</strong></p>
<ul>
<li>Exchange: <code>deduction.exchange</code></li>
<li>Queue: <code>deduction.request.queue</code></li>
<li>Routing Key: <code>deduction.request</code></li>
</ul>
<h4 id="6-1-2-扣费结果消息（扣费系统-→-订单-资源系统）"><a href="#6-1-2-扣费结果消息（扣费系统-→-订单-资源系统）" class="headerlink" title="6.1.2 扣费结果消息（扣费系统 → 订单&#x2F;资源系统）"></a>6.1.2 扣费结果消息（扣费系统 → 订单&#x2F;资源系统）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeductionResultMessage</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String orderNo;            <span class="comment">// 订单号</span></span><br><span class="line">    <span class="keyword">private</span> String deductionNo;        <span class="comment">// 扣费单号</span></span><br><span class="line">    <span class="keyword">private</span> String status;             <span class="comment">// 状态：SUCCESS, FAILED</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal amount;          <span class="comment">// 扣费金额</span></span><br><span class="line">    <span class="keyword">private</span> String failReason;         <span class="comment">// 失败原因</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime deductionTime; <span class="comment">// 扣费时间</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>队列配置：</strong></p>
<ul>
<li>Exchange: <code>deduction.result.exchange</code></li>
<li>Queue: <code>deduction.result.queue</code></li>
<li>Routing Key: <code>deduction.result</code></li>
</ul>
<h4 id="6-1-3-余额不足通知（扣费系统-→-订单-资源系统）"><a href="#6-1-3-余额不足通知（扣费系统-→-订单-资源系统）" class="headerlink" title="6.1.3 余额不足通知（扣费系统 → 订单&#x2F;资源系统）"></a>6.1.3 余额不足通知（扣费系统 → 订单&#x2F;资源系统）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BalanceInsufficientMessage</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long userId;               <span class="comment">// 用户ID</span></span><br><span class="line">    <span class="keyword">private</span> String orderNo;            <span class="comment">// 订单号</span></span><br><span class="line">    <span class="keyword">private</span> String instanceId;         <span class="comment">// 实例ID</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal requiredAmount; <span class="comment">// 所需金额</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal currentBalance; <span class="comment">// 当前余额</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-消息处理"><a href="#6-2-消息处理" class="headerlink" title="6.2 消息处理"></a>6.2 消息处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;deduction.request.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDeductionRequest</span><span class="params">(DeductionRequestMessage message)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 转换为扣费请求</span></span><br><span class="line">        <span class="type">DeductionRequest</span> <span class="variable">request</span> <span class="operator">=</span> convertToRequest(message);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 执行扣费（幂等）</span></span><br><span class="line">        <span class="type">DeductionResult</span> <span class="variable">result</span> <span class="operator">=</span> deductionService.deduct(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 发送扣费结果</span></span><br><span class="line">        <span class="type">DeductionResultMessage</span> <span class="variable">resultMessage</span> <span class="operator">=</span> buildResultMessage(result);</span><br><span class="line">        resultProducer.send(resultMessage);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;处理扣费请求失败&quot;</span>, e);</span><br><span class="line">        <span class="comment">// 发送失败消息或重试</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="七、关键代码实现"><a href="#七、关键代码实现" class="headerlink" title="七、关键代码实现"></a>七、关键代码实现</h2><h3 id="7-1-扣费服务接口"><a href="#7-1-扣费服务接口" class="headerlink" title="7.1 扣费服务接口"></a>7.1 扣费服务接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeductionService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行扣费（幂等）</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request 扣费请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 扣费结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DeductionResult <span class="title function_">deduct</span><span class="params">(DeductionRequest request)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退款</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderNo 订单号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reason 退款原因</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 退款结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    RefundResult <span class="title function_">refund</span><span class="params">(String orderNo, String reason)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 停止周期扣费</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderNo 订单号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">stopPeriodicDeduction</span><span class="params">(String orderNo)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-扣费服务实现（核心逻辑）"><a href="#7-2-扣费服务实现（核心逻辑）" class="headerlink" title="7.2 扣费服务实现（核心逻辑）"></a>7.2 扣费服务实现（核心逻辑）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeductionServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DeductionService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DeductionRecordMapper deductionRecordMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserAccountBalanceService accountBalanceService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AccountTransactionService accountTransactionService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> DeductionResult <span class="title function_">deduct</span><span class="params">(DeductionRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 生成幂等键</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">idempotentKey</span> <span class="operator">=</span> generateIdempotentKey(request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 检查幂等性</span></span><br><span class="line">        <span class="type">DeductionRecordDO</span> <span class="variable">existing</span> <span class="operator">=</span> checkIdempotency(idempotentKey);</span><br><span class="line">        <span class="keyword">if</span> (existing != <span class="literal">null</span> &amp;&amp; DeductionStatusEnum.SUCCESS.equals(existing.getStatus())) &#123;</span><br><span class="line">            <span class="keyword">return</span> DeductionResult.success(existing);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 创建扣费记录</span></span><br><span class="line">        <span class="type">DeductionRecordDO</span> <span class="variable">record</span> <span class="operator">=</span> createDeductionRecord(request, idempotentKey);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 4. 扣减余额</span></span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">balanceBefore</span> <span class="operator">=</span> accountBalanceService.getAccount(request.getUserId()).getBalance();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> accountBalanceService.reduceBalance(</span><br><span class="line">                request.getUserId(), </span><br><span class="line">                request.getAmount(), </span><br><span class="line">                <span class="string">&quot;订单扣费：&quot;</span> + request.getOrderNo()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;余额不足&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">balanceAfter</span> <span class="operator">=</span> accountBalanceService.getAccount(request.getUserId()).getBalance();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 5. 记录账户流水</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">transactionNo</span> <span class="operator">=</span> accountTransactionService.recordTransaction(</span><br><span class="line">                AccountTransactionDO.builder()</span><br><span class="line">                    .userId(request.getUserId())</span><br><span class="line">                    .transactionType(TransactionTypeEnum.CONSUME)</span><br><span class="line">                    .amount(request.getAmount().negate()) <span class="comment">// 负数表示扣款</span></span><br><span class="line">                    .balanceBefore(balanceBefore)</span><br><span class="line">                    .balanceAfter(balanceAfter)</span><br><span class="line">                    .relatedOrderNo(request.getOrderNo())</span><br><span class="line">                    .relatedBusinessNo(request.getInstanceId())</span><br><span class="line">                    .businessType(BusinessTypeEnum.INSTANCE_BILLING)</span><br><span class="line">                    .remark(<span class="string">&quot;订单扣费：&quot;</span> + request.getOrderNo())</span><br><span class="line">                    .build()</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 6. 更新扣费记录</span></span><br><span class="line">            record.setStatus(DeductionStatusEnum.SUCCESS);</span><br><span class="line">            record.setDeductionTime(LocalDateTime.now());</span><br><span class="line">            record.setAccountTransactionNo(transactionNo);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果是周期扣费，设置下次扣费时间</span></span><br><span class="line">            <span class="keyword">if</span> (request.isPeriodic()) &#123;</span><br><span class="line">                record.setNextDeductionTime(LocalDateTime.now().plusHours(request.getPeriodHours()));</span><br><span class="line">                record.setCurrentPeriod(record.getCurrentPeriod() + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            deductionRecordMapper.updateById(record);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> DeductionResult.success(record);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 扣费失败</span></span><br><span class="line">            record.setStatus(DeductionStatusEnum.FAILED);</span><br><span class="line">            record.setFailReason(e.getMessage());</span><br><span class="line">            record.setRetryCount(record.getRetryCount() + <span class="number">1</span>);</span><br><span class="line">            deductionRecordMapper.updateById(record);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> DeductionResult.fail(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generateIdempotentKey</span><span class="params">(DeductionRequest request)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">period</span> <span class="operator">=</span> request.isPeriodic() ? request.getCurrentPeriod() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;%s_%s_%d&quot;</span>, </span><br><span class="line">            request.getOrderNo(), </span><br><span class="line">            request.getDeductionType(), </span><br><span class="line">            period</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> DeductionRecordDO <span class="title function_">checkIdempotency</span><span class="params">(String idempotentKey)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> deductionRecordMapper.selectByIdempotentKey(idempotentKey);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="八、异常处理和重试机制"><a href="#八、异常处理和重试机制" class="headerlink" title="八、异常处理和重试机制"></a>八、异常处理和重试机制</h2><h3 id="8-1-失败场景处理"><a href="#8-1-失败场景处理" class="headerlink" title="8.1 失败场景处理"></a>8.1 失败场景处理</h3><table>
<thead>
<tr>
<th>失败场景</th>
<th>处理方式</th>
<th>重试策略</th>
</tr>
</thead>
<tbody><tr>
<td>余额不足</td>
<td>记录失败原因，发送通知</td>
<td>用户充值后可手动重试</td>
</tr>
<tr>
<td>账户不存在</td>
<td>自动创建账户后重试</td>
<td>自动重试1次</td>
</tr>
<tr>
<td>数据库异常</td>
<td>记录失败，记录重试次数</td>
<td>最多重试3次，每次间隔递增</td>
</tr>
<tr>
<td>网络超时</td>
<td>记录失败，记录重试次数</td>
<td>最多重试3次</td>
</tr>
</tbody></table>
<h3 id="8-2-补偿机制"><a href="#8-2-补偿机制" class="headerlink" title="8.2 补偿机制"></a>8.2 补偿机制</h3><p><strong>场景：</strong> 扣费成功但后续流程失败（如资源创建失败）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> RefundResult <span class="title function_">refund</span><span class="params">(String orderNo, String reason)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 查询扣费记录</span></span><br><span class="line">    List&lt;DeductionRecordDO&gt; records = deductionRecordMapper.selectByOrderNo(orderNo);</span><br><span class="line">    </span><br><span class="line">    <span class="type">BigDecimal</span> <span class="variable">totalRefundAmount</span> <span class="operator">=</span> BigDecimal.ZERO;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (DeductionRecordDO record : records) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!DeductionStatusEnum.SUCCESS.equals(record.getStatus())) &#123;</span><br><span class="line">            <span class="keyword">continue</span>; <span class="comment">// 只退已成功扣费的</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 停止周期扣费（如果是周期扣费）</span></span><br><span class="line">        <span class="keyword">if</span> (record.getIsPeriodic() == <span class="number">1</span>) &#123;</span><br><span class="line">            record.setStatus(DeductionStatusEnum.STOPPED);</span><br><span class="line">            deductionRecordMapper.updateById(record);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 退款</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">refundAmount</span> <span class="operator">=</span> record.getAmount();</span><br><span class="line">        accountBalanceService.addBalance(</span><br><span class="line">            record.getUserId(), </span><br><span class="line">            refundAmount, </span><br><span class="line">            <span class="string">&quot;订单退款：&quot;</span> + orderNo + <span class="string">&quot;，原因：&quot;</span> + reason</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 记录账户流水</span></span><br><span class="line">        accountTransactionService.recordTransaction(<span class="comment">/* 退款流水 */</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. 更新扣费记录</span></span><br><span class="line">        record.setStatus(DeductionStatusEnum.REFUNDED);</span><br><span class="line">        deductionRecordMapper.updateById(record);</span><br><span class="line">        </span><br><span class="line">        totalRefundAmount = totalRefundAmount.add(refundAmount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> RefundResult.success(totalRefundAmount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="九、监控和告警"><a href="#九、监控和告警" class="headerlink" title="九、监控和告警"></a>九、监控和告警</h2><h3 id="9-1-关键指标"><a href="#9-1-关键指标" class="headerlink" title="9.1 关键指标"></a>9.1 关键指标</h3><ol>
<li><strong>扣费成功率</strong>：成功扣费数 &#x2F; 总扣费数</li>
<li><strong>余额不足率</strong>：余额不足次数 &#x2F; 总扣费数</li>
<li><strong>平均扣费耗时</strong>：扣费接口平均响应时间</li>
<li><strong>周期扣费延迟</strong>：实际扣费时间 - 计划扣费时间</li>
</ol>
<h3 id="9-2-告警规则"><a href="#9-2-告警规则" class="headerlink" title="9.2 告警规则"></a>9.2 告警规则</h3><ul>
<li>扣费成功率 &lt; 95%：发送告警</li>
<li>余额不足率 &gt; 10%：发送告警</li>
<li>对账不平：立即告警</li>
<li>周期扣费延迟 &gt; 5分钟：发送告警</li>
</ul>
<hr>
<h2 id="十、实施步骤"><a href="#十、实施步骤" class="headerlink" title="十、实施步骤"></a>十、实施步骤</h2><h3 id="第一阶段：基础功能（1周）"><a href="#第一阶段：基础功能（1周）" class="headerlink" title="第一阶段：基础功能（1周）"></a>第一阶段：基础功能（1周）</h3><ol>
<li>创建扣费记录表</li>
<li>实现扣费服务（包月 + 按小时首扣）</li>
<li>实现退款功能</li>
<li>集成账户流水表</li>
</ol>
<h3 id="第二阶段：周期扣费（1周）"><a href="#第二阶段：周期扣费（1周）" class="headerlink" title="第二阶段：周期扣费（1周）"></a>第二阶段：周期扣费（1周）</h3><ol>
<li>实现定时任务（按小时续扣）</li>
<li>实现余额不足处理</li>
<li>实现停止周期扣费</li>
</ol>
<h3 id="第三阶段：对账和监控（3天）"><a href="#第三阶段：对账和监控（3天）" class="headerlink" title="第三阶段：对账和监控（3天）"></a>第三阶段：对账和监控（3天）</h3><ol>
<li>实现对账任务</li>
<li>添加监控指标</li>
<li>配置告警规则</li>
</ol>
<h3 id="第四阶段：优化和测试（3天）"><a href="#第四阶段：优化和测试（3天）" class="headerlink" title="第四阶段：优化和测试（3天）"></a>第四阶段：优化和测试（3天）</h3><ol>
<li>性能优化</li>
<li>压力测试</li>
<li>异常场景测试</li>
</ol>
<hr>
<h2 id="十一、总结"><a href="#十一、总结" class="headerlink" title="十一、总结"></a>十一、总结</h2><h3 id="11-1-核心优势"><a href="#11-1-核心优势" class="headerlink" title="11.1 核心优势"></a>11.1 核心优势</h3><ol>
<li><strong>资金安全</strong>：通过乐观锁、幂等键、事务保证</li>
<li><strong>高可用</strong>：异步消息、定时任务、失败重试</li>
<li><strong>可追溯</strong>：完整的扣费记录和账户流水</li>
<li><strong>可对账</strong>：定期对账任务，保证数据一致性</li>
<li><strong>系统解耦</strong>：通过消息队列与订单&#x2F;资源系统解耦</li>
</ol>
<h3 id="11-2-注意事项"><a href="#11-2-注意事项" class="headerlink" title="11.2 注意事项"></a>11.2 注意事项</h3><ol>
<li><strong>幂等键设计</strong>：必须包含订单号、扣费类型、周期，保证唯一性</li>
<li><strong>定时任务频率</strong>：建议每分钟执行，避免延迟过大</li>
<li><strong>余额不足处理</strong>：需要与业务方协商，是否自动停止实例</li>
<li><strong>对账机制</strong>：建议每天对账，及时发现数据不一致</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://goppop.github.io">Goppop</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://goppop.github.io/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/">https://goppop.github.io/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://goppop.github.io" target="_blank">Goppop的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/">系统开发</a></div><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" title="数据一致性问题分析与解决方案"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">数据一致性问题分析与解决方案</div></div><div class="info-2"><div class="info-item-1">数据一致性问题分析与解决方案问题背景最近学习es，做了个保单管理demo，修正了自己的一些错误认知 并且认识到将不可管理转换为可间接管理的模式在保单管理系统中，PolicyService.createPolicy() 方法的执行流程如下：  PostgreSQL 保存（同步） Redis 缓存（同步） RabbitMQ 发送消息（同步） Elasticsearch 同步（异步，通过 MQ）  这种多数据源协作模式带来了数据一致性的挑战。  核心问题问题1：ES 同步失败导致的数据不一致场景描述：如果步骤 1-3 成功，但步骤 4（ES 同步）失败或延迟，会出现什么情况？ 回答：  ES 中会丢失这条数据 导致复杂查询从 ES 中取不到数据，但简单查询却能从 DB 或缓存中获取 造成数据不一致 因为事务只在 1-3 步，MQ 中的消息消费处理和前 3 步没有绑定到一起 目前项目中没有处理这种情况  首次提出的解决方案：  分布式事务方案  使用 Seata AT 模式 通过全局事务来一起管理这 4 步的数据操作 但具体实现细节尚未考虑   验证和补偿机制  对 MQ 中发送成功的数...</div></div></div></a><a class="pagination-related" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F-%E4%BB%8E%E8%AE%BE%E8%AE%A1%E5%88%B0%E5%BC%80%E5%8F%91%E5%85%A8%E8%BF%87%E7%A8%8B/" title="算力平台扣费系统：从设计到开发全过程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">算力平台扣费系统：从设计到开发全过程</div></div><div class="info-2"><div class="info-item-1">算力平台扣费系统：从设计到开发全过程 本文记录了一个完整的分布式扣费系统的设计思路、技术选型、架构设计、核心实现以及踩坑经验，适合有一定Java开发经验的读者阅读。  目录 一、项目背景 二、需求分析 三、技术选型 四、架构设计 五、数据库设计 六、核心功能实现 七、关键技术点 八、踩坑与优化 九、测试与验证 十、总结与思考   一、项目背景1.1 业务场景这是一个算力租赁平台的扣费系统，主要业务场景包括：  包月预付费：用户购买包月算力，一次性扣除整月费用 按小时后付费：用户按小时使用算力，每小时自动续扣 退款处理：支持全额退款、部分退款、按订单退款、按扣费单退款 余额预警：提前通知用户余额不足，避免服务突然中断  1.2 核心挑战 资金安全：不能重复扣费，不能多退少退 高并发：支持大量用户同时扣费 幂等性：网络重试、系统故障恢复时不能重复扣费 系统解耦：与订单系统、资源系统解耦，通过消息队列异步通信 可追溯性：每笔扣费都有完整的流水记录，支持对账   二、需求分析2.1 功能需求2.1.1 扣费功能   功能 说明 优先级    包月扣费 一次性扣除整月费用 P0   按小时...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" title="扣费系统使用指南"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-10</div><div class="info-item-2">扣费系统使用指南</div></div><div class="info-2"><div class="info-item-1">扣费系统使用指南一、系统概述扣费系统是算力平台的核心计费模块，支持包月预付费和按小时后付费两种计费方式。系统已完全集成到 pay 模块中。 核心功能 包月扣费（预付费）：一次性扣除整月费用 按小时扣费（后付费）：首小时扣费 + 周期续扣 退款处理：订单取消或失败时的退款 定时任务：自动执行周期续扣和对账 同步调用：直接调用扣费服务，实时返回结果  二、数据库表结构1. 扣费记录表表名：tgkw_deduction_record SQL文件位置：sql/mysql/system/deduction_record.sql 执行以下SQL创建表： 12-- 在你的MySQL数据库中执行source sql/mysql/system/deduction_record.sql;  三、API接口说明1. 创建扣费接口地址： POST /admin-api/pay/deduction/create 权限： pay:deduction:create 请求示例（包月）： 1234567891011&#123;  &quot;orderNo&quot;: &quot;ORD20231201001&...</div></div></div></a><a class="pagination-related" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%8E%A5%E6%96%87%E6%A1%A3/" title="扣费系统对接文档"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-10</div><div class="info-item-2">扣费系统对接文档</div></div><div class="info-2"><div class="info-item-1">扣费系统对接文档1. 概述扣费系统为订单系统提供统一的扣费和退款能力，支持一次性扣费和周期性扣费两种模式。 核心能力：  一次性扣费（包月预付费） 周期扣费（按小时后付费） 全额退款和部分退款 停止周期扣费 余额预警（提前3天和1天预警） 幂等性保证  服务信息：  服务名称：pay-server 基础路径：&#x2F;admin-api&#x2F;pay&#x2F;deduction  快速导航：  如何对接扣费接口：见 第2章：快速开始 如何使用余额预警：见 第7.4节：订单系统如何使用 消息推送说明：见 第6章：消息推送 典型场景示例：见 第5章：典型场景  2. 快速开始2.1 添加依赖12345&lt;dependency&gt;    &lt;groupId&gt;cn.ksxzcx.cloud&lt;/groupId&gt;    &lt;artifactId&gt;tgwk-module-pay-api&lt;/artifactId&gt;    &lt;version&gt;$&#123;project.version&#125;&lt;/version&gt;...</div></div></div></a><a class="pagination-related" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F-%E4%BB%8E%E8%AE%BE%E8%AE%A1%E5%88%B0%E5%BC%80%E5%8F%91%E5%85%A8%E8%BF%87%E7%A8%8B/" title="算力平台扣费系统：从设计到开发全过程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-10</div><div class="info-item-2">算力平台扣费系统：从设计到开发全过程</div></div><div class="info-2"><div class="info-item-1">算力平台扣费系统：从设计到开发全过程 本文记录了一个完整的分布式扣费系统的设计思路、技术选型、架构设计、核心实现以及踩坑经验，适合有一定Java开发经验的读者阅读。  目录 一、项目背景 二、需求分析 三、技术选型 四、架构设计 五、数据库设计 六、核心功能实现 七、关键技术点 八、踩坑与优化 九、测试与验证 十、总结与思考   一、项目背景1.1 业务场景这是一个算力租赁平台的扣费系统，主要业务场景包括：  包月预付费：用户购买包月算力，一次性扣除整月费用 按小时后付费：用户按小时使用算力，每小时自动续扣 退款处理：支持全额退款、部分退款、按订单退款、按扣费单退款 余额预警：提前通知用户余额不足，避免服务突然中断  1.2 核心挑战 资金安全：不能重复扣费，不能多退少退 高并发：支持大量用户同时扣费 幂等性：网络重试、系统故障恢复时不能重复扣费 系统解耦：与订单系统、资源系统解耦，通过消息队列异步通信 可追溯性：每笔扣费都有完整的流水记录，支持对账   二、需求分析2.1 功能需求2.1.1 扣费功能   功能 说明 优先级    包月扣费 一次性扣除整月费用 P0   按小时...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Goppop</div><div class="author-info-description">周期越大，结构越清晰</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Goppop"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%97%E5%8A%9B%E5%B9%B3%E5%8F%B0%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88"><span class="toc-number">1.</span> <span class="toc-text">算力平台扣费系统设计方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%AE%BE%E8%AE%A1%E7%9B%AE%E6%A0%87"><span class="toc-number">1.1.</span> <span class="toc-text">一、设计目标</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%A0%B8%E5%BF%83%E9%9C%80%E6%B1%82"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 核心需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 设计原则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.2.</span> <span class="toc-text">二、核心架构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%B3%BB%E7%BB%9F%E5%88%86%E5%B1%82"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 系统分层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 数据模型设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E6%89%A3%E8%B4%B9%E8%AE%B0%E5%BD%95%E8%A1%A8%EF%BC%88deduction-record%EF%BC%89"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">2.2.1 扣费记录表（deduction_record）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E8%B4%A6%E6%88%B7%E6%B5%81%E6%B0%B4%E8%A1%A8%EF%BC%88account-transaction%EF%BC%89"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">2.2.2 账户流水表（account_transaction）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.3.</span> <span class="toc-text">三、核心流程设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%8C%85%E6%9C%88%E6%89%A3%E8%B4%B9%E6%B5%81%E7%A8%8B%EF%BC%88%E9%A2%84%E4%BB%98%E8%B4%B9%EF%BC%89"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 包月扣费流程（预付费）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%8C%89%E5%B0%8F%E6%97%B6%E6%89%A3%E8%B4%B9%E6%B5%81%E7%A8%8B%EF%BC%88%E5%90%8E%E4%BB%98%E8%B4%B9%EF%BC%89"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 按小时扣费流程（后付费）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E9%A6%96%E5%B0%8F%E6%97%B6%E6%89%A3%E8%B4%B9"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">3.2.1 首小时扣费</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-%E5%91%A8%E6%9C%9F%E7%BB%AD%E6%89%A3%EF%BC%88%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%EF%BC%89"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">3.2.2 周期续扣（定时任务）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E9%80%80%E6%AC%BE%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 退款流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%B9%82%E7%AD%89%E6%80%A7%E4%BF%9D%E8%AF%81%E6%9C%BA%E5%88%B6"><span class="toc-number">1.4.</span> <span class="toc-text">四、幂等性保证机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%B9%82%E7%AD%89%E9%94%AE%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 幂等键设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%B9%82%E7%AD%89%E6%80%A7%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 幂等性实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 数据库唯一索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.5.</span> <span class="toc-text">五、定时任务设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E6%8C%89%E5%B0%8F%E6%97%B6%E7%BB%AD%E6%89%A3%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 按小时续扣任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E4%BD%99%E9%A2%9D%E4%B8%8D%E8%B6%B3%E5%A4%84%E7%90%86"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 余额不足处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E5%AF%B9%E8%B4%A6%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.5.3.</span> <span class="toc-text">5.3 对账任务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E4%B8%8E%E8%AE%A2%E5%8D%95-%E8%B5%84%E6%BA%90%E7%B3%BB%E7%BB%9F%E8%A7%A3%E8%80%A6"><span class="toc-number">1.6.</span> <span class="toc-text">六、与订单&#x2F;资源系统解耦</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 消息队列设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-1-%E6%89%A3%E8%B4%B9%E8%AF%B7%E6%B1%82%E6%B6%88%E6%81%AF%EF%BC%88%E8%AE%A2%E5%8D%95%E7%B3%BB%E7%BB%9F-%E2%86%92-%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%EF%BC%89"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">6.1.1 扣费请求消息（订单系统 → 扣费系统）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-2-%E6%89%A3%E8%B4%B9%E7%BB%93%E6%9E%9C%E6%B6%88%E6%81%AF%EF%BC%88%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F-%E2%86%92-%E8%AE%A2%E5%8D%95-%E8%B5%84%E6%BA%90%E7%B3%BB%E7%BB%9F%EF%BC%89"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">6.1.2 扣费结果消息（扣费系统 → 订单&#x2F;资源系统）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-3-%E4%BD%99%E9%A2%9D%E4%B8%8D%E8%B6%B3%E9%80%9A%E7%9F%A5%EF%BC%88%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F-%E2%86%92-%E8%AE%A2%E5%8D%95-%E8%B5%84%E6%BA%90%E7%B3%BB%E7%BB%9F%EF%BC%89"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">6.1.3 余额不足通知（扣费系统 → 订单&#x2F;资源系统）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 消息处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.7.</span> <span class="toc-text">七、关键代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E6%89%A3%E8%B4%B9%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 扣费服务接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E6%89%A3%E8%B4%B9%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0%EF%BC%88%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91%EF%BC%89"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 扣费服务实现（核心逻辑）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">1.8.</span> <span class="toc-text">八、异常处理和重试机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E5%A4%B1%E8%B4%A5%E5%9C%BA%E6%99%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.8.1.</span> <span class="toc-text">8.1 失败场景处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E8%A1%A5%E5%81%BF%E6%9C%BA%E5%88%B6"><span class="toc-number">1.8.2.</span> <span class="toc-text">8.2 补偿机制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E7%9B%91%E6%8E%A7%E5%92%8C%E5%91%8A%E8%AD%A6"><span class="toc-number">1.9.</span> <span class="toc-text">九、监控和告警</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E5%85%B3%E9%94%AE%E6%8C%87%E6%A0%87"><span class="toc-number">1.9.1.</span> <span class="toc-text">9.1 关键指标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-number">1.9.2.</span> <span class="toc-text">9.2 告警规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E5%AE%9E%E6%96%BD%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.10.</span> <span class="toc-text">十、实施步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%8A%9F%E8%83%BD%EF%BC%881%E5%91%A8%EF%BC%89"><span class="toc-number">1.10.1.</span> <span class="toc-text">第一阶段：基础功能（1周）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%91%A8%E6%9C%9F%E6%89%A3%E8%B4%B9%EF%BC%881%E5%91%A8%EF%BC%89"><span class="toc-number">1.10.2.</span> <span class="toc-text">第二阶段：周期扣费（1周）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%AF%B9%E8%B4%A6%E5%92%8C%E7%9B%91%E6%8E%A7%EF%BC%883%E5%A4%A9%EF%BC%89"><span class="toc-number">1.10.3.</span> <span class="toc-text">第三阶段：对账和监控（3天）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E9%98%B6%E6%AE%B5%EF%BC%9A%E4%BC%98%E5%8C%96%E5%92%8C%E6%B5%8B%E8%AF%95%EF%BC%883%E5%A4%A9%EF%BC%89"><span class="toc-number">1.10.4.</span> <span class="toc-text">第四阶段：优化和测试（3天）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">1.11.</span> <span class="toc-text">十一、总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-%E6%A0%B8%E5%BF%83%E4%BC%98%E5%8A%BF"><span class="toc-number">1.11.1.</span> <span class="toc-text">11.1 核心优势</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">1.11.2.</span> <span class="toc-text">11.2 注意事项</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" title="数据一致性问题分析与解决方案">数据一致性问题分析与解决方案</a><time datetime="2025-12-11T16:00:00.000Z" title="发表于 2025-12-12 00:00:00">2025-12-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" title="扣费系统使用指南">扣费系统使用指南</a><time datetime="2025-12-09T16:00:00.000Z" title="发表于 2025-12-10 00:00:00">2025-12-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E5%AF%B9%E6%8E%A5%E6%96%87%E6%A1%A3/" title="扣费系统对接文档">扣费系统对接文档</a><time datetime="2025-12-09T16:00:00.000Z" title="发表于 2025-12-10 00:00:00">2025-12-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F-%E4%BB%8E%E8%AE%BE%E8%AE%A1%E5%88%B0%E5%BC%80%E5%8F%91%E5%85%A8%E8%BF%87%E7%A8%8B/" title="算力平台扣费系统：从设计到开发全过程">算力平台扣费系统：从设计到开发全过程</a><time datetime="2025-12-09T16:00:00.000Z" title="发表于 2025-12-10 00:00:00">2025-12-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/code-learning/%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/%E6%89%A3%E8%B4%B9%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/" title="算力平台扣费系统设计方案">算力平台扣费系统设计方案</a><time datetime="2025-12-09T16:00:00.000Z" title="发表于 2025-12-10 00:00:00">2025-12-10</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Goppop</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.1.1</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.3-b1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3-b1"></script><script src="/js/main.js?v=5.5.3-b1"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>